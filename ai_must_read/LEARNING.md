# LEARNING.md - ?????????

????????? `cn_vertical` ??????????????????????,???????????

---

## ??

1. [Lua ??????](#1-lua-??????)
2. [LuaTeX dir ????](#2-luatex-dir-????)
3. [????????](#3-????????)
4. [PDF ????](#4-pdf-????)
5. [??????](#5-??????)
6. [??????](#6-??????)
7. [????????](#7-????????)
8. [???????](#8-???????)
9. [LaTeX expl3 boolean ??????](#9-latex-expl3-boolean-??????)
10. [\\selectfont ?? LuaTeX ??](#10-selectfont-??-luatex-??)
11. [LaTeX3 \\fontsize ??????????](#11-latex3-fontsize-??????????)
12. [LaTeX3 Keys ?????? \\tl_if_empty:NTF ??](#12-latex3-keys-??????-tl_if_emptyntf-??)
13. [TikZ WHATSIT ??? cn_vertical ??????](#13-tikz-whatsit-???-cn_vertical-??????)
14. [\directlua ?? Lua ??? LaTeX ?????](#14-directlua-??-lua-???-latex-?????)
15. [Lua ?????????????](#15-lua-?????????????)
16. [????????? (Split Page)](#16-?????????-split-page)
17. [?????????????](#17-?????????????)
18. [???????????????](#18-??????????????????)
19. [ExplSyntaxOn ???? \directlua ????](#19-explsyntaxon-????-directlua-????)
20. [?????????????????](#20-?????????????????)
21. [????????????????](#21-????????????????)

---

## 1. Lua ??????

### ????
? `cn_vertical.sty` ??? `\directlua` ?? Lua ???,????????,?????????

### ????

#### ?? 1:?? `\directlua` ?????
- **??**:??????????(?? `pcall`?`kpse.find_file` ?)?????? `\directlua` ??
- **??**:???????????,???? `pcall()` ?????????
- **??**:`tex.error()` ? `\directlua` ?????????,??????

#### ?? 2:??? `package.loaded` ????????
```lua
-- ? ????:???? package.loaded
package.loaded['base_constants'] = result

-- ? ????:????????
cn_vertical_constants = result
package.loaded['base_constants'] = result
```

#### ?? 3:`dofile` vs `require` ?????
- **??**:?? `dofile("constants.lua")` ??? `require('base_constants')`
- **??**:
  - `dofile` ????????,??? Lua ???????
  - `dofile` ?????????,???? `package.loaded` ??
  - ???????????????

### ????

**????**:
1. **?? `require()` ?? `dofile()`**
2. **???????????**(? `base_constants`?`render_page` ?)
3. **?????????? `package.loaded`**:
   ```lua
   package.loaded['module_name'] = module_table
   return module_table
   ```
4. **???????**:???????? `\directlua` ???,??????
5. **????????**:
   ```latex
   \directlua{
     package.loaded["base_constants"] = nil
     package.loaded["base_utils"] = nil
     % ... ????
   }
   ```

---

## 2. LuaTeX dir ????

### ???????

| ???? | ???? |
|---------|---------|
| ? "dir ??????????,????????" | ? `RTT` ???????????(??)????(??) |
| ? "??????????????" | ? ?????????,?? `dir` ?????,???????? |
| ? "vbox ???????" | ? ??? vbox ????????**???????**,`dir RTT` ???????? |

### ????

**LuaTeX ? `dir` ??(??? `RTT` ??)???????????????**

????:
1. **`\pardir RTT \textdir RTT`**:???????"????",??????"????"
2. **`\vbox dir RTT`**:?? RTT ???????
3. **???? `\hsize`**:??????,`\hsize` ??????
4. **?????**:? `\hbox to \hsize{\hfill ...}` ??,?????????

### ??
??????"?????????"????????? LuaTeX ???????,???????????????

---

## 3. ????????

### ????
?? `font_scale` ???????,???????(? `h_align="right"`)??????,?????????

### ????
**? LuaTeX ?,`font.define()` ????????,`font.getfont(new_font_id)` ?? `nil`?**

- `font.define()` ????? ID,?????????? LuaTeX ????
- ?????? `font.getfont(scaled_font_id)` ?????????
- ???????? 0 ????,??????

### ????

**??? `font.define()` ?????????????**:

```lua
-- ? ????:???????????
local base_font_data = font.getfont(font_id)  
local font_scale_factor = params.font_scale or 1.0

-- ??????
local scaled_font_id = font.define(...)

-- ??????????????? × ????
if base_font_data and base_font_data.characters[cp] then
    local gw = base_font_data.characters[cp].width * font_scale_factor
    local gh = base_font_data.characters[cp].height * font_scale_factor
end
```

### ??
- LuaTeX ??? API ??????????????
- ?????????????????
- ???????????,????????????

---

## 4. PDF ????

### ?? 1:????(??????)

**??**:??????,?????????????

**??**:?????? PDF ??
- ? ??:`"black rg"` (PDF ???????)
- ? ??:`"0 0 0 rg"` (??????? RGB ??)

**??**:
- ???????? `base_utils.normalize_rgb()` ??
- ?? `pdf_literal` ?? `q` (save) ? `Q` (restore) ????

### ?? 2:???????(????)

**??**:???????,??????

**??**:PDF ?"????",??????????????

**??**:
- ????????:?? `insert_before(p_head, p_head, bg_node)`
- ??????
- ????????(???)

**???????**(?????????):
```lua
-- 1. ???:???
p_head = background.draw_background(p_head, ...)

-- 2. ???:??????
p_head = background.set_font_color(p_head, ...)

-- 3. ??:?????
p_head = border.draw_outer_border(p_head, ...)

-- 4. ???:??????(??)
-- (???????)

-- 5. ??(??):????
if draw_debug then
    p_head = utils.draw_debug_rect(...)
end
```

### ??
- PDF ?????????,??????
- ?? `insert_before(head, head, node)` ??????? = ???? = ???

---

## 5. ??????

### ??:?????? (Double Free)

**??**:?????,???? "node memory in use, expected value X"

**??**:
1. ?????????,?? `node.free()` ??
2. ?????????????,??????

**??**:
```lua
-- ? ????
local n = head
head = D.getnext(head)
node.free(D.tonode(n))  -- ??!?? n ???????

-- ? ????
local n = head
D.setnext(D.getprev(n), D.getnext(n))  -- ???
-- ?? n ?????????????
```

### ??:Textbox ????

**??**:???????????? textbox,??????

**??**:???? textbox ????

**??**:
```lua
-- ? core_main.lua ??????????
node.set_attribute(new_box, constants.ATTR_TEXTBOX_WIDTH, 0)
node.set_attribute(new_box, constants.ATTR_TEXTBOX_HEIGHT, 0)
```

### ??
- **?????????? LuaTeX ???????**
- ????????????????
- ?????????????????

---

## 6. ??????

### ????:??????

???????,???**?????**:
- `base_` - ???
- `core_` - ???
- `flatten_` - ???
- `layout_` - ???
- `render_` - ???

**??**:
1. ???????????
2. ??????????
3. ??????(? `render.lua` vs `render_page.lua`)
4. ??????????

### ????:?????

**??**:??????,?? `require('constants')` ??????

**??**:
1. ?????? `require()` ??
2. ?? `.sty` ???? `package.loaded` ????
3. ?? `dofile()` ? `require()`

**??**:
- ??????"????",?????????????
- ?? `package.loaded` ???? `require()` ?????
- ?????????,??????

---

## 7. ????????

### ??:????????????

**??**:?? `lower-yuwei` ???,????????

**??????**:
```
cn_vertical.sty (????)
    ? ??? Lua
core_main.lua (?????)
    ? ??????
render_page.lua (??????)
    ? ???????
render_banxin.lua (????)
    ? ???????
draw_banxin() (????)
```

??,???? `guji.cls`,???:
```
guji.cls (?? key-value)
    ? ??? cn_vertical
cn_vertical.sty
    ? ... ??????
```

### ??
- **????????????????**
- ??????????
- ????????????????
- ?????????????

---

## 8. ???????

### ???????

1. **????**:????????,????
2. **??????**:??????????????(? `test_lower_yuwei.tex`)
3. **??????**:???????
4. **??????**:??????????????

### Debug ??

1. **??????**:`\GujiDebugOn` ? `debug=true`
2. **?? PDF ??**:?? PDF ??????????? PDF ??
3. **?? `utils.debug_log()`**:??????????
4. **????**:???????,??????

---

## 16. ????????? (Split Page)

### ????
??????????????:??????(? 297mm × 210mm)???????????(148.5mm × 210mm),??????,???????

### ????

#### ?? 1:`\AtBeginShipout` ???? `\newpage`
?????? `atbegshi` ?? shipout ?????:
```latex
% ? ????:???????
\AtBeginShipout{
    % ?????
    \shipout\box\AtBeginShipoutBox
    % ?????
    \newpage  % ??!newpage ????? shipout,??????
}
```
**??**:`\AtBeginShipout` ??? shipout ?????,???? `\newpage` ????? shipout,?????

#### ?? 2:LuaTeX ? `\pdfliteral` ??
LuaTeX ??? pdfTeX ? `\pdfliteral` ??:
```latex
% ? pdfTeX ??(LuaTeX ???)
\pdfliteral{q 0 0 100 200 re W n}

% ? LuaTeX ??
\pdfextension literal{q 0 0 100 200 re W n}
```

#### ?? 3:`tex.box` ??? `\copy` ??????
? Lua ?? `tex.box[n] = node_list` ?????,???????????? TeX????????????????(????????),???? `node.copy_list()` ????:

```lua
-- ? ????:???????????,??? \copy ??????
function vertical.load_page(box_num, index)
    tex.box[box_num] = _G.vertical_pending_pages[index + 1]
end

-- ? ????:??????
function vertical.load_page(box_num, index, copy)
    local box = _G.vertical_pending_pages[index + 1]
    if box then
        if copy then
            tex.box[box_num] = node.copy_list(box)  -- ????
        else
            tex.box[box_num] = box
        end
    end
end
```

### ??????

**? `vertical.process_from_tex()` ???????**:

```lua
if split_enabled then
    for i = 0, total_pages - 1 do
        -- ????(?? copy=true ???????????)
        tex.print(string.format("\\directlua{vertical.load_page(%d, %d, true)}", box_num, i))

        -- ?????????
        tex.print(string.format("\\global\\pagewidth=%.5fpt", target_w_pt))
        tex.print(string.format("\\global\\pageheight=%.5fpt", target_h_pt))

        -- ?????:?????,?????????????
        tex.print(string.format("\\noindent\\kern-%.5fpt\\copy%d", target_w_pt, box_num))

        -- ??,?????(?????)
        tex.print("\\newpage")
        tex.print(string.format("\\noindent\\copy%d", box_num))
    end
end
```

### ????

```
ltc-guji.cls
    +-- ?? split-page / split-page-right-first ?
    +-- ?? \splitpageSetup ?? Lua ??
    +-- ?? \enableSplitPage ????
           ?
luatex-cn-splitpage.sty
    +-- ?? LaTeX ?? (\splitpageSetup, \enableSplitPage)
    +-- ?? Lua ?? splitpage.configure() / splitpage.enable()
           ?
luatex-cn-splitpage.lua
    +-- ???? (source_width, source_height, right_first)
    +-- ?????? (is_enabled(), get_target_width(), ...)
           ?
luatex-cn-vertical-core-main.lua
    +-- process_from_tex() ?? splitpage.is_enabled()
        +-- true: ??????(??+??),??????
        +-- false: ????
```

### ??

1. **?? TeX ? shipout ??**:
   - `\AtBeginShipout` ? shipout ?????,?????? shipout
   - ?? shipout ????????????

2. **LuaTeX ????**:
   - `\pdfextension literal` ?? `\pdfliteral`
   - `\pdfextension` ????? LuaTeX ??? PDF ????

3. **???????**:
   - `tex.box[n] = node` ????????? TeX
   - ??????????? `node.copy_list()`
   - ????????? `_G.vertical_pending_pages` ???????

4. **PDF ???????**:
   - ??? PDF clipping path (`q ... re W n ... Q`)
   - ???? `\pagewidth` / `\pageheight` ??????
   - ???????? PDF ???????

5. **????**:
   - ?? "node memory still in use" ??????????????
   - ?? `pdfinfo` ????????
   - ? Lua ??? `texio.write_nl()` ??????

### ??????
- ????:`src/splitpage/luatex-cn-splitpage.lua`
- LaTeX ??:`src/splitpage/luatex-cn-splitpage.sty`
- ?????:`src/ltc-guji.cls`(? 222-228, 268-281 ?)
- ??????:`src/vertical/luatex-cn-vertical-core-main.lua`(`process_from_tex` ??)

---

## ??:????

1. **?????????**:?????????
2. **???????????**:???????????
3. **?????????**:???????????
4. **???????????**:????????
5. **PDF ???????**:???????????
6. **?????????**:????????????
7. **????,????**:???????????
8. **?? TeX/LuaTeX ?????**:? shipout ?????`\pdfextension` ?????????

---

## 9. LaTeX expl3 boolean ??????

### ????
? `guji.cls` ??????? `cn_vertical.sty` ?,??:
`! LaTeX Error: Key 'cn_vertical/lower-yuwei' accepts boolean values only.`

### ????
? `\keys_set:nn` ?,??? `.bool_set:N` ??????????(? `\bool_if:NTF ...`),??????????,?????? token ??? `true` ? `false`?????????? token ?????,?????

### ????
??? `\keys_set:nn` ??,?? `\bool_if:NTF` ????,???????:

```latex
% ? ????
\keys_set:nn { cn_vertical } {
    lower-yuwei = \bool_if:NTF \l_guji_lower_yuwei_bool { true } { false }
}

% ? ????
\bool_if:NTF \l_guji_lower_yuwei_bool 
  { \keys_set:nn { cn_vertical } { lower-yuwei = true } }
  { \keys_set:nn { cn_vertical } { lower-yuwei = false } }
```

### ??
- `expl3` ? `keys_set:nn` ???????????
- ????????,????????,????????????????,???? `\keys_set:nx`(????????????)?
- ??????????????"??"?????????????????,????? `\gujiSetup` ?????????

---

## 10. \selectfont ?? LuaTeX ??

### ????
??(jiazhu)??????,?? `\jiazhu` ?????(??? debug ??),???????? jiazhu ???

### ????
**`\selectfont` ???????????? LuaTeX ??!**

? commit acf4b5d ?,`\setluatexattribute` ??????? `\selectfont` **??**:

```latex
% ? ????(??????)
\NewDocumentCommand{\jiazhu}{ +m }
  {
    \group_begin:
    \setluatexattribute\cnverticaljiazhu{1}  % ? ????
    \fontsize{...}{...}\selectfont          % ? selectfont ?????!
    #1  % ? ????????
    \group_end:
  }
```

### ????
1. **??**:PDF ????????
2. **????**:?????????,? `flatten_nodes.lua` ??????????
3. **????**:?? debug ??,?? `[flatten] Found JIAZHU` ??????
4. **????**:??? TeX ??????,?????? Lua
5. **????**:?? commit cc9cee4(????)vs acf4b5d(????),?? `\setluatexattribute` ???????

### ????
**?????????????**:

```latex
% ? ????
\NewDocumentCommand{\jiazhu}{ +m }
  {
    \group_begin:
    
    % 1. ???????
    \fontsize{...}{...}\selectfont
    
    % 2. CRITICAL: ? selectfont ??????
    \setluatexattribute\cnverticaljiazhu{1}
    
    % 3. ??????,????
    #1
    \group_end:
  }
```

### ??
1. **`\selectfont` ???"???"??**,????????????,?? LuaTeX ??
2. **???????????**:
   - ? ? `\selectfont` **??**?? = ????
   - ? ? `\selectfont` **??**?? = ????
3. **?????????**:
   - ? Lua ? flatten ??? debug:`D.get_attribute(node, ATTR_XXX)`
   - ? layout ??? debug:????????
   - ??????,??????????
4. **Git ??????**:
   - ????????,?????????
   - ???????(??????????)
5. **???????**:? `\selectfont` ??????????????????????

### ??????
- ????:`cn_vertical.sty` ? 530 ?
- ????:???? `\jiazhu` ?????
- ????:acf4b5d ??bug,????

---

## 11. LaTeX3 `\fontsize` ??????????

### ????
??(jiazhu)??? PDF ????,????????????,?????????????,??????? 0.70pt(??? 19.6pt)?

### ????
1. **??**:??????,????????
2. **????**:???????????,???
3. **????**:? render ????????:
   ```
   [render] GLYPH char=40643 [c:0, r:0] w=28.00 h=21.00 fsize=28.00  # ????
   [render] GLYPH char=23569 [c:0, r:3] w=0.70 h=0.50 fsize=0.70     # ????!
   ```
4. **????**:????? 0.70pt ??? 19.6pt(28 × 0.7)

### ????

**LaTeX3 ? `\regex_match:nnTF` ????????????????**

????????????? jiazhu-size ????????(????):

```latex
% ? ????
\regex_match:nnTF { ^[0-9\.]+$ } { \l_tmpa_tl }  % "0.7" ????!
  {
    % ??????(????)
    \fontsize{\fp_eval:n { 0.7 * 28 } pt}...
  }
  {
    % ?????(??????????)
    \fontsize{0.7}{0.7}\selectfont  % ??? 0.7pt ???!
  }
```

????? `^[0-9\.]+$` ? LaTeX3 ????? catcode ????????? "0.7" ???????

### ????

**????:????????,??????????(???)**:

```latex
% ? ????:????,?????
\tl_if_empty:NTF \l__cn_vertical_jiazhu_size_tl
  {
    % ??:????? 70%
    \tl_set:Nx \l_tmpa_tl { \fp_eval:n { 0.7 * \f@size } pt }
  }
  {
    % ????(?????? "14pt")
    \tl_set_eq:NN \l_tmpa_tl \l__cn_vertical_jiazhu_size_tl
  }
\fontsize{\l_tmpa_tl}{\l_tmpa_tl}\selectfont
```

**????**:
- ????????(? "0.7"),??????????(? "14pt")
- ?????????(0.7 × ????),????????
- ???? `jiazhu-size` ?? `jiazhu-font-size`,???

### ??
1. **??????????**:
   - ??????(?????????)??????
   - ???????????
   - ?????????????
2. **???????????**:
   - ? Lua ??? `font.getfont(id).size`
   - ?????????????? ID ???
3. **??????**:
   - ??????(????)????????
   - ?????????????????
4. **???????**:
   - `jiazhu-font-size` ? `jiazhu-size` ???
   - ????????????????

### ??????
- ????:`cn_vertical.sty` ? 515-525 ?
- ???:`jiazhu-font-size`(? `jiazhu-size` ???)
- ????:??(jiazhu)??????

---

## 12. LaTeX3 Keys ?????? `\tl_if_empty:NTF` ??

### ????
??? #11 ?,????????????? `\l__cn_vertical_jiazhu_size_tl` ? `\tl_if_empty:NTF` ???"??",??????????

### ????
????? `guji.cls` ? `cn_vertical.sty` ???????:

```latex
% guji.cls
\cnvSetup{
    jiazhu-font-size = \l_guji_jiazhu_font_size_tl  % ??? tl
}
```

? `\l_guji_jiazhu_font_size_tl` ???,expl3 keys ?????"??"????,????????????(????? `{}`)?`\tl_if_empty:NTF` ???? token ????,???"????"?

### ????
????????:

```latex
% ?? - ????????
\tl_if_empty:NTF \l__cn_vertical_jiazhu_size_tl { default } { use }

% ?? - ??????
\tl_set:Nx \l_tmpb_tl { \l__cn_vertical_jiazhu_size_tl }
\tl_if_empty:NTF \l_tmpb_tl { default } { use }
```

### ??
1. **LaTeX3 ? `\tl_if_empty:NTF` ???? token ??**:
   - ??? `{}` ???????
   - keys ?????????????? token
2. **????????????**:
   - `\iow_term:x { value: |\the_var| }` ??????
3. **?????????????**:
   - ??? cls/sty ???????,??????????
   - ???????????

---

## 13. TikZ WHATSIT ??? cn_vertical ??????

### ????
??? TikZ ? `tikzpicture` ??(? `remember picture, overlay`)???? `guji-content` ???,?????????????????????????????

### ????
1. **??**:TikZ ??? PDF ????,?? `\includegraphics` ???????
2. **????**:?? WHATSIT ??????? `flatten_nodes.lua`?`layout_grid.lua`?`render_page.lua`
3. **????**:????? `print()` ????????????
4. **????**:
   - `flatten_nodes.lua` **???** WHATSIT ??(ID=8,S=29)
   - `layout_grid.lua` **???** ?? ID=8 ??
   - `render_page.lua` **???** WHATSIT ??(ID=8,S=16),???? `[NOT POSITIONED]`

### ????
**TikZ ? `remember picture, overlay` ?????? `\shipout` ???,??????????**

??????:
1. **??????**:`flatten_nodes.lua` ?? `D.copy(t)` ??????,`layout_map` ?????????
2. **????**:TikZ ??? WHATSIT ????? HLIST ?,?????????-??-????
3. **??????**:???????????(S=29 vs S=16),???????????
4. **????**:`render_page.lua` ??? WHATSIT ??? `layout_grid.lua` ??????????

### ????

**?? `\AddToHook{shipout/foreground}` ? `\AddToHook{shipout/background}` ??**:

```latex
% ? ????:?? shipout ??
\AddToHook{shipout/foreground}{%
  \ifnum\value{page}=1
    \begin{tikzpicture}[remember picture, overlay]
      \node[anchor=north east, opacity=0.7, ...] at (current page.north east) {
        \includegraphics[width=12.9cm]{image.png}
      };
    \end{tikzpicture}
  \fi
}

% ? ????:???? guji-content
\begin{guji-content}
  \begin{tikzpicture}[remember picture, overlay]
    ...  % ??????
  \end{tikzpicture}
\end{guji-content}
```

### ??? WHATSIT ????
?? TikZ overlay ???,??????? WHATSIT ?????????:

- **`flatten_nodes.lua`**(? 168-172 ?):
  ```lua
  elseif tid == constants.GLUE or tid == constants.WHATSIT then
      if tid == constants.WHATSIT or subtype == 0 or ... then
         keep = true
         if tid == constants.WHATSIT then has_content = true end
      end
  ```

- **`layout_grid.lua`**(? 181-191 ?):
  ```lua
  if id == constants.WHATSIT then
      layout_map[t] = { page = cur_page, col = cur_col, row = cur_row }
      t = D.getnext(t)
      goto start_of_loop
  end
  ```

- **`render_page.lua`**(? 243-245 ?):
  ```lua
  elseif id == constants.WHATSIT then
      -- Keep WHATSIT nodes in the list for TikZ/other special content
      -- Note: For TikZ overlay, use shipout hooks instead
  ```

### ??
1. **?????????**:
   - TikZ ? `remember picture, overlay` ???????????
   - ??? `\shipout` ?????????
   - ????????????????

2. **????????**:
   - `D.copy()` ?????????????
   - `layout_map` ???????,?????????
   - ????????????????????

3. **?? WHATSIT ?????**:
   - ?? `print()` ?? `utils.debug_log()`(???? debug ??)
   - ???????ID ? subtype:`print(string.format("[...] Node=%s ID=%d S=%d", tostring(t), id, subtype))`
   - ?????(flatten/layout/render)?????

4. **?????????**:
   | ?? | ???? |
   |------|---------|
   | ????/?? | `\AddToHook{shipout/background}` |
   | ????/?? | `\AddToHook{shipout/foreground}` |
   | ????? | ????? `\ifnum\value{page}=N` |
   | ??????? | ??? TikZ,??? `\includegraphics` ???? Textbox |

### ??????
- ????:`shiji.tex` ? 7-16 ?
- ?????:`flatten_nodes.lua`?`layout_grid.lua`?`render_page.lua`(??? WHATSIT ??,?? TikZ overlay ??)

---

## 14. \directlua ?? Lua ??? LaTeX ?????

### ????
? `cn_vertical.sty` ? `guji.cls` ? `\directlua` ???? Lua ??(`--`)?,????????????,????????????,????(?????)?????

### ????
**LaTeX ??? `\directlua{...}` ?,??????"???"(Linearize)???????? Lua ???**

- **?????**:
  ? LaTeX ?:
  ```latex
  \directlua{
    local x = 1
    -- ??????
    local y = 2
  }
  ```
  ?? Lua ??????????:
  `local x = 1 -- ?????? local y = 2`
  ?? Lua ? `--` ??????????,?????? `--` ?????????????????

- **??????**:
  - `%` ? LaTeX ??????? Lua ????????
  - ? `\directlua` ????,???? `\%`,?? LaTeX ????????

### ????
1. **??**:???????????????
2. **????**:???????????
3. **????**:???? `tostring(hook_function)` ????????????,???????????
4. **????**:???????? `print("[A]")` ???,???????? `print("[B]")` ????
5. **????**:? `[A]` ? `[B]` ???? `--` ??? Lua ???

### ????

**????**:
1. **??? `\directlua` ??? Lua ??? (`--`)**:
   - ??????,?? Lua ????:`--[[ ???? ]]--`?
   - ???????????????
2. **??????**:
   - ???? `\%` ???????
3. **?? Lua ????**:
   - ??????????? `.lua` ????
   - `\directlua` ??? `require()` ???????
4. **???????? "Long"**:
   - ???? `\NewDocumentCommand` ?????(? `\cnvLua`),???? `+m` ?? `m`,?? Lua ?????????? `Runaway argument` ???
   ```latex
   \NewDocumentCommand{\cnvLua}{ +m }{ \directlua{... #1 ...} }
   ```
5. **??"????"??**:
   - ???????????,??????????

### ??
1. **??????????**:???????????????,????????"??"??
2. **??????**:???? Lua ?????? LaTeX ???,??? LaTeX ??????
3. **?? pcall ??????**:
   ```latex
   \directlua{
     local status, err = pcall(function() require('module') end)
     if not status then print("ERROR: " .. err) end
   }
   ```
   *??:??????????????,pcall ???????,???????????????*

### ??????
- ????:`cn_vertical.sty` ? `guji.cls`
- ????:???? LaTeX ???? Lua ??
- ????:2026-01-15 ????????

---

## 15. Lua ?????????????

### ????
????????,???????????,??????????(????????????)?

### ????
1. **Lua ???? (Shadowing)**:???????,`src/banxin` ???????? `banxin_main.lua`?LuaTeX ?????????,????????????,?????????????
2. **????????**:?? LaTeX ? Lua ???????????,`font_size` ?????????(? `render_page.lua`)???,????????????????????????

### ????
1. **????????**:?? `src/banxin` ? `texmf` ??????,???????,???????
2. **???????**:???????????????????,?????? `params.font_size` ? `color_str` ????????
3. **???????**:? `render_banxin.lua` ???"???"(Block Centering)???????????,?????????,?????????(Cap)???????????

### ??
- ?????,????????(???????????????????)??????????
- ???? LaTeX-Lua ?????,**??????????????**?????????????
- `debug.getinfo` ??????????,?? `print()` ??????????????????????

---

## 17. ?????????????

### ????
???????(Paragraph)???????,????????:
1. **????**:????????(???)??????????
2. **????**:???????????????????,????????????

### ????

#### ?? 1:Glue ??????????
?????????(Glue,?? LaTeX ?? `\parskip` ? `\Space`)?,???????????????,?????(Lookahead)??:
- **??**:????????????,????"??"??????????
- **??**:??????????(Glyph),????????????????????????"??"??????????,???????????????,???????????

#### ?? 2:??????????
- **??**:??? `\par` ? `penalty` ??(?????)?????,????????????????,???????????
- **????**:??????,?????????????????????????????????(? `cur_row <= cur_column_indent`),??? `penalty` ???????,?????????????

### ????

#### 1. ???????? (Lookahead Termination)
? `layout_grid.lua` ????????,????????????:
- ? **???????**:?? `GLYPH`?`HLIST`?`VLIST`?`RULE` ??????????
- ? **????????**:?? `penalty <= -10000` ????
- ? **???????**:???? `WHATSIT`?`MARK`?`KERN`(????????)??

#### 2. ???????? (Leading Spacing Suppression)
?? TeX ?????????:
- **??**:???????????????(`cur_row <= cur_column_indent`),?????????????
- **????**:????????????(`cur_row > cur_column_indent`)?,`penalty` ?????????????

### ??
1. **??????**:???? `while lookahead` ??????????????,??????????
2. **????????**:?????????"?????????"?"?????????"????????????????
3. **????????**:?????????,???????????????????,????????????

---

## 18. ????(???)???????????

### ????
???????(???)???,?? `shipout/foreground` ???????(Seal)??????????????,???? PDF ???(????????????)????????

### ????
1. **????????????**:
   - ????????,????(Spread)?????(? 40cm)?
   - ????? `shipout` ?????? `\pagewidth` ???(? 20cm),???????
   - ?? `\paperwidth` ?????????????
2. **TikZ ???????**:
   - ??????? `at (\paperwidth, 0)` ?????????
   - ??????????,?????????? `\pagewidth` ????,?????"????"??
3. **????????**:
   - ??????????????????,??? `\value{page}` ?????????????(???)????????????,????????

### ????

#### 1. ?? `\pagewidth` ?? `\paperwidth`
? `shipout` ???,`\pagewidth` ????????????????????? `(\pagewidth, 0)` ????????????????

#### 2. ???????? (Spread-to-Physical Mapping)
?????????????,???????????????:
- **??? 2N-1 (??????)**:
  - ??:`(\pagewidth, 0)`
  - ??:`xshift = -\g_yinzhang_xshift_tl` (??????)
- **??? 2N (??????)**:
  - ??:`(\pagewidth, 0)`
  - ??:`xshift = \pagewidth - \g_yinzhang_xshift_tl`
  - *??*:??????????? spread ?????,???????????????????????,????"??"??????

### ??
1. **??????????? \paperwidth**:????????????????,`\pagewidth` ?? `\paperwidth` ???????????
2. **??? vs ???**:????????????????,?????????????(????????)????????????????
3. ** foreground ????????**:????????????????,????????????

### ??????
- ????:`ltc-guji.cls` ?? `\YinZhang` ?????
- ????:???? `split-page=true` ???????????????

---

## 19. ExplSyntaxOn ???? \directlua ????

### ????
? `\ExplSyntaxOn` ????????,???? `\directlua{...}` ?? Lua ?????????,??? Lua ????:
```
[\directlua]:1: <eof> expected near 'end'.
```

### ????
**`\ExplSyntaxOn` ?????????????**:
- ? expl3 ???,???????(catcode 9)
- ?????????
- ? `\directlua` ?? Lua ???????,???????? expl3 ?????,Lua ????"??"???
- ?? Lua ???? `if ... then ... end` ??,?????? `if ... then ... end end`(????????)

### ????
```latex
\ExplSyntaxOn
\NewDocumentCommand{\updateSplitPageStatus}{ }
  {
    \directlua{
      if splitpage.is_enabled() then
        tex.sprint("\\SplitPageEnabledtrue")
      else
        tex.sprint("\\SplitPageEnabledfalse")
      end
    }
  }
\ExplSyntaxOff
```
?? Lua ?????????:
```lua
ifsplitpage.is_enabled()thentex.sprint("\\SplitPageEnabledtrue")elsetex.sprint("\\SplitPageEnabledfalse")end
```

### ????

**?? 1:??????? `\ExplSyntaxOff` ??**
```latex
\ExplSyntaxOn
% ... ?? expl3 ?? ...
\ExplSyntaxOff

% ? ExplSyntaxOff ?????? \directlua ???
\newcommand{\updateSplitPageStatus}{%
  \directlua{
    if splitpage.is_enabled() then
      tex.sprint("\\SplitPageEnabledtrue")
    else
      tex.sprint("\\SplitPageEnabledfalse")
    end
  }%
}
```

**?? 2:?? expl3 ? `\lua_now:e` ? `\lua_now:n`**
```latex
\ExplSyntaxOn
\cs_new:Npn \updateSplitPageStatus
  {
    \lua_now:e
      {
        if~splitpage.is_enabled()~then~
          tex.sprint("\\SplitPageEnabledtrue")~
        else~
          tex.sprint("\\SplitPageEnabledfalse")~
        end
      }
  }
\ExplSyntaxOff
```
??:???? `~` ?????

**?? 3:? Lua ??????? .lua ???**
```latex
% ? .sty ???
\directlua{require('my-module')}

% ? my-module.lua ?
function update_split_page_status()
    if splitpage.is_enabled() then
        tex.sprint("\\SplitPageEnabledtrue")
    else
        tex.sprint("\\SplitPageEnabledfalse")
    end
end
```

### ??
1. **ExplSyntaxOn ?? catcode**:? expl3 ???,?????????????? LaTeX ??
2. **\directlua ? expl3 ???**:?? Lua ??? expl3 ???????
3. **?????**:
   - expl3 ???? LaTeX ????
   - \directlua ?????? \ExplSyntaxOff ??
   - ?? Lua ??????? .lua ???
4. **????**:
   - ???? `<eof> expected near 'end'` ???????????
   - ????????? `\ExplSyntaxOn` ???
   - ?? `\show\commandname` ?????????

### ??????
- ????:`src/splitpage/luatex-cn-splitpage.sty`
- ????:`\updateSplitPageStatus`?`\updateSplitPageSide` ????? Lua ?????

---

## 20. ?????????????????

### ????
??? `\begin{??}[indent=2]...\end{??}` ???,???????????,????????????????????

### ????
????????:

#### ?? 1:environ ????????
`guji-content`(??)???? `\NewEnviron` ??,??????????? `\BODY`?????:
- `\begin{??}` ??? `cnverticalindent=2` ??
- `\end{??}` ??????? `\BODY` ????????
- ????????????**???????**
- ????????????,???????????????

#### ?? 2:????????
????? `\end{??}` ????????????,????????:
```lua
-- layout_grid.lua ??????
if cur_row < indent then cur_row = indent end
if indent > cur_column_indent then cur_column_indent = indent end  -- ????!
if cur_row < cur_column_indent then cur_row = cur_column_indent end
```
`cur_column_indent` ?**???**??????????? `indent=2` ???,?????? 2,??????????(?? `indent=0` ?????)????????????

### ????

#### 1. ??????????
```latex
% luatex-cn-vertical.sty - Paragraph ????
\NewDocumentEnvironment{Paragraph}{ O{} }
  {
    \par
    \stepcounter{cnverticalblockid}
    \keys_set:nn { vertical / paragraph } { #1 }
    \setluatexattribute\cnverticalindent{\l__cn_vertical_para_indent_int}
    % ... ??????
  }
  {
    % ? \par ??????,?????????
    \setluatexattribute\cnverticalindent{0}
    \setluatexattribute\cnverticalfirstindent{-1}
    \setluatexattribute\cnverticalrightindent{0}
    \par
  }
```

#### 2. ??????????????
```lua
-- layout_grid.lua - ????????
-- Only apply column-level indent tracking when this node has indent > 0
-- This prevents indent from "leaking" to non-indented content in the same column
if indent > 0 then
    if cur_row < indent then cur_row = indent end
    if indent > cur_column_indent then cur_column_indent = indent end
    if cur_row < cur_column_indent then cur_row = cur_column_indent end
end
```

### ????
1. **?? Lua ????**:? `layout_grid.lua` ???????? `raw_indent` ?
2. **????**:
   - ?????:`raw_indent=2`
   - ?????:`raw_indent=nil`(?????)
3. **????**:??????,`cur_column_indent` ???????????
4. **????**:?? `if indent > 0` ???,????????????????????

### ??
1. **?? environ ??????**:
   - `\NewEnviron` ???????????
   - ??????????:????????????
   - ?????????????????

2. **???? vs ?????**:
   - LuaTeX ???????,????????
   - ????? `cur_column_indent` ?????,?????????
   - ????????:???????"????"???????????

3. **?????????**:
   ```lua
   -- ? layout_grid.lua ???????
   if node_count <= 40 then
       texio.write_nl(string.format("[DEBUG] Node %d: raw_indent=%s",
           node_count, tostring(D.get_attribute(t, constants.ATTR_INDENT))))
   end
   ```

4. **????**:
   - TeX ????????????
   - Lua ???????????
   - ??????????,??????

### ??????
- TeX ????:`src/vertical/luatex-cn-vertical.sty`(Paragraph ????)
- Lua ????:`src/vertical/luatex-cn-vertical-layout-grid.lua`(? 239-246 ?)
- ??????:`src/vertical/luatex-cn-vertical-base-constants.lua`

---

## 21. ????????????????
22. ????? (Floating TextBox) ???????
23. Whatsit ?????? PDF ??????????

### ????
?? `luatex-cn-font-autodetect.sty` ? `.lua` ???,?????:
```
[Font Auto-Detect] ERROR: fontdetect module not loaded
```
?
```
module 'fonts' not found
```

### ????

#### ?? 1:`\directlua` ? Lua ???????
? `\directlua` ??? Lua ???????,????????,???????????????????? `pcall` ??,???????????????,??????????

#### ?? 2:`require()` ?????????
```lua
-- ? ????:?? require ????????
local fonts = require("fonts")  -- ???????,??????

-- ? ????:?? pcall ??
local ok, fonts = pcall(require, "fonts")
if ok and fonts then
    -- ?? fonts
end
```

#### ?? 3:? Lua ? TeX ?????????
```lua
-- ? ????:\string ???????
tex.print("\\string\\setmainfont{SimSun}")

-- ? ????:\noexpand ????????????
tex.sprint("\\noexpand\\setmainfont{SimSun}")
```

### ????

#### 1. ?? Lua ????
```lua
-- luatex-cn-font-autodetect.sty ?? \directlua
texio.write_nl("term and log", "[Font Auto-Detect] Starting")
fontdetect = nil
local lua_file = kpse.find_file("luatex-cn-font-autodetect.lua", "lua")
if lua_file then
  texio.write_nl("term and log", "[Font Auto-Detect] kpse found: " .. lua_file)
  fontdetect = dofile(lua_file)
else
  -- ??????
  local paths = {"../src/fonts/luatex-cn-font-autodetect.lua", "src/fonts/luatex-cn-font-autodetect.lua"}
  for _, path in ipairs(paths) do
    local f = io.open(path, "r")
    if f then
      f:close()
      fontdetect = dofile(path)
      break
    end
  end
end
if fontdetect then
  texio.write_nl("term and log", "[Font Auto-Detect] Module ready")
else
  fontdetect = { get_font_setup = function() return nil end }
end
```

#### 2. ?????????
?? LuaTeX ??????????????(`fonts.names.resolve` ? API ?????),??????????????????,? fontspec ??????????:

```lua
-- luatex-cn-font-autodetect.lua
function fontdetect.font_exists(fontname)
    -- ?????????,?? OS ??
    -- ???????,fontspec ??????????
    return true
end
```

#### 3. ?? `token.set_macro` ????? TeX
```lua
-- Lua ??:?? TeX ?
local font_setup = fontdetect.get_font_setup()
if font_setup then
  token.set_macro("fontauto@fontname", font_setup.name)
  token.set_macro("fontauto@features", font_setup.features)
else
  token.set_macro("fontauto@fontname", "")
end
```

```latex
% TeX ??:????? \setmainfont
\ifx\fontauto@fontname\empty\else
  \expandafter\setmainfont\expandafter{\fontauto@fontname}[\fontauto@features]%
\fi
```

### ????

#### ?? `texio.write_nl` ??????
```lua
texio.write_nl("term and log", "[Font Auto-Detect] ????")
```

#### ??????????
```bash
# ?????????
lualatex file.tex 2>&1 | grep "\[Font Auto-Detect\]"

# ????????????
cat file.log | grep -A5 "Fatal\|error"
```

#### ????????
| ???? | ???? |
|---------|---------|
| `'end' expected near <eof>` | Lua ????,?? `function/end`?`if/end` ???? |
| `module 'xxx' not found` | `require` ??????,??? `pcall` ?? |
| `Missing character` | ????????,?????????? |

### ??????

#### ??
?? `src/` ?????,???????????

#### ??
TeX Live ? `texmf` ?????,?????????

#### ????
```bash
# ???????????
lualatex file.tex 2>&1 | grep "luatex-cn"

# ??????
cat "c:/Users/lisdp/texmf/tex/latex/luatex-cn/fonts/luatex-cn-font-autodetect.sty"
```

### ?????????

| ?? | ??? | ?? | ?? | ?? |
|------|-------|------|------|------|
| Windows | SimSun | SimHei | KaiTi | FangSong |
| macOS | Songti SC | PingFang SC | Kaiti SC | STFangsong |
| Linux (Fandol) | FandolSong | FandolHei | FandolKai | FandolFang |
| Linux (Noto) | Noto Serif CJK SC | Noto Sans CJK SC | - | - |

### ??
1. **Lua ??????**:? `\directlua` ???????? `pcall`,?????????
2. **?? fontspec**:?????????????,??? fontspec ????????
3. **????? `token.set_macro`**:? Lua ? TeX ????,?? `token.set_macro` ???,??? TeX ?????
4. **??????**:?????? TeX ???????????

### ??????
- LaTeX ??:`src/fonts/luatex-cn-font-autodetect.sty`
- Lua ??:`src/fonts/luatex-cn-font-autodetect.lua`
- ?????:`src/ltc-guji.cls`(`\ApplyAutoFont` ??)

# ?????????? (Lessons Learned)

## 1. ????? TeX ?????
**??**: ?? `\fontsize{0.6\f@size}{...}` ?? crash (`! Illegal unit of measure`).
**??**: `\f@size` ?????????(? `10.5`),??????????TeX ? `\fontsize` ??????????? `\fontsize` ???????? `0.6` ???,TeX ???????????????????
**??**: ?? TeX ????????
```latex
\dimen0=\f@size pt
\dimen0=0.6\dimen0
\fontsize{\dimen0}{\dimen0}\selectfont
```
**??**: ? TeX ?????????,???? `\dimexpr` ????,???????????????????

## 2. ??????????“?”???
**??**: ????????????????
**??**: 
1. **??? vs ???**: `luatex-cn-vertical` ?,??? 0 ????(???????)????? PDF ???,??????????
2. **“??”???**: ??? `C` ???????? `C` ???(????)????????,???? `(RTL_Col + 1) * Width` ???(??????????,???????? ??????????)?
**??**: 
????????????:
`Anchor_X = (Physical_Col + 1) * Grid_Width`
???????????(???)???????????

## 3. LuaTeX Whatsit ?????
**??**: ?? `subtype` id ??? `whatsit` ?????,????? LuaTeX ?????
**??**: ?????????? `user_id` ????????? `luatexbase.new_user_whatsit` ??? ID(??????)???“????”?????? subtype ????

## 4. ???????
**??**: ?????????????,????? `print`????????,??????,? `utils.debug_log` (????) ?? `print`,??????????

## 5. Expl3 Syntax Scope
**??**: ? `.sty` ????? `expl3` ??(? `\keys_define:nn`)?,????? `\NewDocumentCommand` ? LaTeX2e ??,???? `\ExplSyntaxOn` ?????
**??**: `\NewDocumentCommand` ??? `\ExplSyntaxOn` ?????,?????????? expl3 ??(???????? TeX ??),???????????? Key-Value ??,? `\ExplSyntaxOn` ???????? `\keys_define:nn` ? `\NewDocumentCommand` ????,?????,?????? `_` ? `:` ???

## 6. TeX ??????????????????

### ??
??(Sidenote)?????????????,?? `\color{red}` ???????????????,???????????????

### ??
1. **???????**: ?? `\setbox0=\hbox{\color{red} text}` ?,`\color` ????? Color Push ??????,?????????????,Color Pop ???????????(??? `\hbox` ??????),???????? Push ?? Pop?? Lua ?????????????????????,?????????????
2. **?????????**: ??????,??? `node.next` ????????(???????? Whatsit?Glue ?)???????"????",???????????????????

### ????
1. **?? `\textcolor` ??**: ?? `\textcolor{red}{text}`,????? Push ? Pop ???????????,?? Pop ?????? `\hbox` ???????
2. **???????**: ? Lua ?????,??????(Glyph, HList, VList, Rule)????????,?? Whatsit ??????

### ??
- ?????,???? `\textcolor` ???????????,???????? `\color`,??????????(Box Capture)?????
- ? Lua ?????????,????"????"?"????",????????????

## 7. ????? (Floating TextBox) ???????

### ??
???????(Floating Mode)?,?????????,??????????(????????)????“??”??

### ??
**???????????**?
? Lua ???????,???????,??? `Kern(x) + Box` ?????? TeX ?????????,?????????????? Kern ?,????????,??????????????????
???????????“??”,?? PDF ?????,????????,???????????????????,?????????

### ????
**????????????????**?

1. **?????**:???????????????,?????**???**?????? $(0,0)$?
    - $X$ ?????,$Y$ ??????
    - **????**:?? TeX ? Page Box ??? `geometry` ??????(Margin),???????????????????????? Lua ??????????
    - ????????:
        - `rel_x = x_input - margin_right`
        - `rel_y = y_input - margin_top`
    - ? `dir RTT` ???,`Kern(rel_x)` ???????

2. **????**:
???????,???????“???? Kern”,???????
```lua
-- 1. ???????????? (????)
local rel_x = item.x - params.margin_right
-- 2. ????
p_head = D.insert_before(p_head, p_head, Kern(rel_x))
D.insert_after(p_head, Kern(rel_x), box)
-- 3. CRITICAL: ????,?? Overlay
D.insert_after(p_head, box, Kern(-(rel_x + box_width)))
```
??,??????????????? Overlay ???

## 8. Whatsit ?????? PDF ??????????

### ??
???????“??/??”?????? Whatsit ??(??????????????),??? PDF ???:`! Unidentified user defined whatsit node should be one you have r \def'ed.`

### ??
**???????**?
??? Whatsit ??? Lua ???????,????? PDF ??(Backend)??,????? shipout ??????????? Lua ??????????,? TeX ?????????????????? PDF ???

### ????
**????,????**?
???(Apply Positions)??,? Whatsit ?????????(???????????????????)?,???????????????**??**?**??**?

```lua
if id == constants.WHATSIT then
    local uid = D.getfield(curr, "user_id")
    if uid == constants.SIDENOTE_ID or uid == constants.FLOATING_ID then
        -- ????...
        -- ?????????,??????
        p_head = D.remove(p_head, curr)
        node.flush_node(D.tonode(curr))
    end
end
```

### ??
- ?????????“????”,????????????????????????
- ??????? PDF ??????“??”?,?????? Glyph, Kern, Glue, Rules ? HList/VList?