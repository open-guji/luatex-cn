# 列间距视觉指南

## 竖排布局的方向理解

### 物理布局 vs 逻辑顺序

```
┌─────────────────────────────────────────┐
│ 页面顶部                                  │
├─────────────────────────────────────────┤
│                                         │
│   [第3列]    [第2列]    [第1列]          │
│     │         │         │              │
│     │         │         │              │
│     ▼         ▼         ▼              │
│   后文      中间      起始文本           │
│                                         │
│   ← ─ ─ ─ ─ ─ ─ ─ ─ ─                  │
│     阅读方向（从右向左）                  │
│                                         │
├─────────────────────────────────────────┤
│ 页面底部                                  │
└─────────────────────────────────────────┘
```

### 术语对应表

| 术语 | 物理方向 | 逻辑含义 | 代码参数 |
|------|---------|---------|---------|
| "上" | 页面顶部 | 列的右侧 | spacing-top |
| "下" | 页面底部 | 列的左侧 | spacing-bottom |
| "前" | 阅读顺序之前 | 列的右边 | - |
| "后" | 阅读顺序之后 | 列的左边 | - |

## 列间距详解

### spacing-top（上间距）

**物理位置**：列的右边
**逻辑位置**：阅读顺序的"前方"

```
        ┌─── spacing-top (3pt)
        │
        ▼
    ┌──────┐
    │ 第2列 │
    │  字  │
    │  符  │
    └──────┘
```

### spacing-bottom（下间距）

**物理位置**：列的左边
**逻辑位置**：阅读顺序的"后方"

```
    ┌──────┐
    │ 第2列 │
    │  字  │
    │  符  │
    └──────┘
        ▲
        │
        └─── spacing-bottom (5pt)
```

### 完整示例：两列之间的间距

```
     spacing-top    spacing-bottom   spacing-top
         (3pt)          (5pt)           (3pt)
           │              │               │
           ▼              ▼               ▼
       ┌──────┐       ┌──────┐       ┌──────┐
       │ 列3  │       │ 列2  │       │ 列1  │
       │  后  │       │  中  │       │  首  │
       │  文  │       │  间  │       │  列  │
       └──────┘       └──────┘       └──────┘
                  ▲
                  │
                  └── 实际间距 = 5pt + 3pt = 8pt
                      (列2的bottom + 列3的top)
```

## 自动列宽计算

### 公式

```
column_width = font_size × width_scale

默认：width_scale = 1.2（留 20% 余量）
```

### 示例

```latex
% 小字号（正文）
\行[font-size=15pt]{正文}
→ 列宽 = 15pt × 1.2 = 18pt

% 大字号（标题）
\行[font-size=48pt]{史記卷十六}
→ 列宽 = 48pt × 1.2 = 57.6pt

% 自定义缩放
\行[font-size=32pt, width-scale=1.5]{章节名}
→ 列宽 = 32pt × 1.5 = 48pt
```

### 视觉对比

```
固定列宽（旧方式）：
┌──┐ ┌──┐ ┌──┐ ┌──┐
│大│ │字│ │重│ │叠│  ← 字符太大，列宽太窄，重叠！
└──┘ └──┘ └──┘ └──┘
 20pt  20pt  20pt  20pt

自动列宽（新方式）：
┌────┐ ┌────┐ ┌────┐ ┌────┐
│ 大 │ │ 字 │ │ 正 │ │ 常 │  ← 列宽自动增大，字符清晰
└────┘ └────┘ └────┘ └────┘
  58pt   58pt   58pt   58pt
  (48pt × 1.2)
```

## 段落间距

### 触发条件

1. `\par` 命令
2. `\end{段落}` 环境结束
3. 连续空行（自动转为 `\par`）

### 视觉效果

```
正文段落1         正文段落2
   ┌──┐             ┌──┐
   │最│             │第│
   │后│             │二│
   │一│             │段│
   │字│             │首│
   └──┘             └──┘
     ▲               ▲
     │               │
     └───────────────┘
       paragraph-spacing
          (8pt)

转换为列数 = ceil(8pt / grid_width)
例如 grid_width=20pt，则跳过 1 列
```

## 实际应用示例

### 史记排版示例

```latex
% 模板配置（中华书局风格）
\contentSetup{
    font-size = 15pt,
    grid-width = 20pt,
    auto-column-width = true,
    width-scale = 1.2,
    column-spacing-top = 2pt,
    column-spacing-bottom = 3pt,
    paragraph-spacing = 8pt,
}

% 卷名（大标题）
\newcommand{\卷名}[1]{%
  \文本框[
    font-size=48pt,          % 字号 48pt
    width-scale=1.2,         % 列宽 = 57.6pt
    spacing-top=5pt,         % 右边留 5pt
    spacing-bottom=5pt       % 左边留 5pt
  ]{#1}%
}

% 章节名（中标题）
\newcommand{\章节名}[1]{%
  \文本框[
    font-size=32pt,          % 字号 32pt
    width-scale=1.2,         % 列宽 = 38.4pt
    spacing-top=3pt,
    spacing-bottom=3pt
  ]{#1}%
}

% 文档内容
\begin{正文}
\卷名{史記卷十六}

\begin{段落}[indent=1]
\章节名{秦楚之際月表第四}
\end{段落}

\begin{段落}[indent=3]
索隱張晏曰：「時天下未定，參錯變易，不可以年記，故列其月。」
\end{段落}
% ↑ 段落结束后自动插入 paragraph-spacing (8pt)

太史公讀秦楚之際，曰：初作難，發於陳涉...
\end{正文}
```

### 预期布局

```
页面从右向左排列：

  5pt    57.6pt   5pt  8pt  3pt 38.4pt 3pt  3pt  18pt  3pt
   │      │       │    │    │    │     │    │    │     │
   ▼      ▼       ▼    ▼    ▼    ▼     ▼    ▼    ▼     ▼
┌────┬────────┬────┬────┬───┬──────┬───┬───┬─────┬───┐
│    │        │    │    │   │      │   │   │     │   │
│    │  史    │    │段  │   │  秦  │   │   │ 索  │   │
│    │  記    │    │间  │   │  楚  │   │   │ 隱  │   │
│    │  卷    │    │距  │   │  之  │   │   │ 張  │   │
│    │  十    │    │    │   │  際  │   │   │ 晏  │   │
│    │  六    │    │    │   │  月  │   │   │ 曰  │   │
│    │        │    │    │   │  表  │   │   │ ...  │   │
│    │        │    │    │   │  第  │   │   │     │   │
│    │        │    │    │   │  四  │   │   │     │   │
└────┴────────┴────┴────┴───┴──────┴───┴───┴─────┴───┘
      ↑                        ↑               ↑
    大标题                   中标题           正文
   (卷名)                  (章节名)        (15pt)
```

## Grid Mode vs Free Mode 对比

### Grid Mode（古籍）

```
固定网格，无间距：

┌──┬──┬──┬──┬──┬──┬──┬──┐
│10│9 │8 │7 │6 │5 │4 │3 │
│  │  │  │  │  │  │  │  │
└──┴──┴──┴──┴──┴──┴──┴──┘
  ▲                    ▲
  │                    │
  每列固定 12pt，无间距
```

### Free Mode（现代）

```
灵活列宽，自适应间距：

┌────┬──┬────┬──┬──┬──┬──┬──┐
│ 大 │间│ 中 │间│小│间│小│间│
│ 标 │距│ 标 │距│字│距│字│距│
│ 题 │  │ 题 │  │  │  │  │  │
└────┴──┴────┴──┴──┴──┴──┴──┘
  ▲      ▲      ▲
  │      │      │
 48pt   32pt   15pt (自动列宽)
```

## 参数优先级

```
列宽计算优先级：
1. column-width (显式指定)     ← 最高
2. font-size × width-scale     ← 自动计算
3. grid-width (全局默认)       ← 兜底

间距优先级：
1. \行[spacing=...] (局部)     ← 最高
2. \contentSetup (环境)
3. 模板 .cfg (全局)
4. 0pt (硬编码默认)            ← 兜底
```

## 注意事项

### ⚠️ Grid Mode 限制

在 Grid Mode 下（`n-column > 0`）：
- ❌ 列间距不生效（固定网格）
- ❌ 段间距不生效
- ❌ 自动列宽不生效
- ✅ 仅 grid-width 和 grid-height 有效

### ✅ Free Mode 推荐

在 Free Mode 下（`n-column = 0`）：
- ✅ 完全灵活的列宽
- ✅ 自动避免字符重叠
- ✅ 精细的间距控制
- ✅ 段落间距自动插入

## 迁移指南

### 从固定宽度迁移

```latex
% 旧代码
\行[width=100pt]{内容}

% 新代码（推荐自动宽度）
\行[font-size=48pt, width-scale=1.2]{内容}
% 列宽 = 48pt × 1.2 = 57.6pt（自动计算）

% 新代码（仍可固定）
\行[column-width=100pt]{内容}
```

### 从 Grid 模式迁移

```latex
% 旧代码（Grid）
\contentSetup{
    grid-width = 12pt,
    n-column = 10,  % 固定 10 列
}

% 新代码（Free）
\contentSetup{
    font-size = 12pt,
    n-column = 0,           % 灵活列数
    auto-column-width = true,
    width-scale = 1.2,
    column-spacing = 2pt,
    paragraph-spacing = 6pt,
}
```
