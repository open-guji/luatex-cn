# 调试发现与技术总结 (Debugging Findings & Technical Summary)

在实现**中式页码系统**以及修复**幻影红框 (Phantom Red Box)** 的过程中，我们有以下核心发现与改进：


---

## 2. 幻影红框问题 (The Phantom Red Box Issue)

### 2.1 现象描述
在页面右侧（页边距之外）会出现一个孤立的红色矩形框，其大小通常与某个文本块或篇名块一致。

### 2.2 根本原因探究 (Root Cause)
- **漏出的调试节点**：红框实际上是 `GridTextbox` 内部渲染产生的调试矩形（`pdf_literal` 节点）。
- **坐标系漂移 (Coordinate Drift)**：
    - 在内部渲染阶段，布局引擎错误地应用了主文档的全局偏置 (`shift_x`)。
    - `shift_x` 通常是为了将整个版面居中而设置的巨大数值（如数百点）。
    - 这导致原本应该在文本框本地坐标 (0,0) 位置的红框，被画到了相对于文本框原点向右偏移几百点的位置。
- **持久化 bug**：这些 `pdf_literal` 节点作为文本框内容的一部分被打包。当文本框被放置到主页面时，由于相对偏移过大，红框就出现在了页面最右侧的"幻影"位置。

### 2.3 解决方案
- **方案 A (预防为主)**：修改 `core_main.lua`。当 `is_textbox` 为真时，强制设置 `shift_x` 和 `shift_y` 为 0。这保证了内部渲染的所有调试元素都严格限制在文本框自身的边界内。
- **方案 B (健壮性检查)**：在 `render_page.lua` 的最终渲染循环中加入非法坐标过滤。如果一个节点计算出的列索引 (`col`) 为负数或无效值，说明它是一个漂移的无效节点，渲染器将跳过该节点的调试绘图，防止干扰主界面。

---

## 3. 架构优化建议

- **统一位置计算**：目前已将 Glyph 和 Block 的位置计算逻辑部分统一。未来应进一步将版心 (Banxin) 元素的定位也纳入该体系，减少重复的坐标变换代码。
- **属性继承**：对于像缩进 (`ATTR_INDENT`) 这样的属性，通过手动在 `core_textbox.lua` 中显式传递，解决了列表环境中嵌套文本框的缩进失效问题。这种"属性显式下传"模式在 LuaTeX 异步处理环境中最为可靠。

---
*编者注：该文档记录了 2026年1月14日 关于页码与渲染 Bug 的专项修复过程。*
