# 使用 dir 属性实现竖排：成功路径

## 结论

**LuaTeX 的 `dir` 属性（特别是 `RTT` 模式）是实现中文竖排的最佳原生方案。**

之前的尝试失败是因为没有正确理解 `dir` 属性的作用范围和容器对齐方式。经过验证，使用 `\vbox dir RTT` 配合正确的容器封装，可以完美实现：
1.  **汉字竖排**：字符从上到下排列。
2.  **列从右到左**：行会自动换列，且第一列在最右侧，后续列向左排列。
3.  **页面右对齐**：通过外部容器控制整体位置。

---

## 核心实现：RTT 模式

LuaTeX 提供了 `RTT` (Right-to-Left Top-to-Bottom) 方向代码，这正是传统中文竖排所需的模式。

### 关键要素

1.  **`\pardir RTT \textdir RTT`**: 
    - 告诉 TeX 引擎文本流动方向是“从上到下”，而行（列）的堆叠方向是“从右到左”。

2.  **`\vbox dir RTT`**:
    - 创建一个垂直盒子，强制其内部使用 RTT 方向系统。

3.  **显式高度 (`\hsize`)**:
    - 在竖排模式下，`\hsize` 实际上定义了**列的高度**（即横排时的宽度）。
    - 必须设置一个合理的 `\hsize`，否则内容不会换行（换列）。

4.  **右对齐封装**:
    - 默认情况下，盒子可能停留在左侧。
    - 需要用一个右对齐的 `\hbox` 包裹整个 `\vbox`，确保文字出现在页面的右侧（符合古籍阅读习惯）。

### 成功代码示例

```lua
function cn_vertical.vertical_rtt(text)
    -- 设定列的高度（竖排时的垂直长度）
    local vertical_height = "300pt" 
    
    tex.print("\\par")
    -- 1. 创建一个占满宽度的水平盒子，内部右对齐 (\hfill)
    tex.print("\\hbox to \\hsize{\\hfill")
    
    -- 2. 核心竖排盒子: 方向设为 RTT
    tex.print("\\vbox dir RTT {")
    tex.print("\\hsize=" .. vertical_height) -- 强制高度，触发换列
    tex.print("\\pardir RTT \\textdir RTT")  -- 设定内部文本方向
    tex.print("\\noindent " .. text)
    tex.print("}") -- end vbox
    
    tex.print("}") -- end hbox
    tex.print("\\par")
end
```

---

## 之前的误区修正

| 之前的错误观点 |现在的正确认识 |
|---|---|
| ❌ "dir 无法改变字符排列方式，只能改变流动方向" | ✅ `RTT` 模式同时改变了文字流向（上下）和行流向（右左）。|
| ❌ "需要复杂的节点回调来处理竖排" | ✅ 对于基本的汉字竖排，原生 `dir` 属性已足够，无需手动操作节点。|
| ❌ "vbox 简单堆叠即最好" | ✅ 简单的 vbox 堆叠无法自动处理**从右到左的换列**，`dir RTT` 则是原生支持多列布局。 |

## 下一步计划

目前的实现已经解决了最核心的布局问题。后续可以关注：
- **标点旋转**：虽然简单的汉字无需旋转，但某些标点在竖排时可能需要字形替换或旋转（OpenType `vert` 特性通常能自动处理）。
- **英混合排**：如果混入英文，可能需要更精细的节点控制来让英文字母顺时针旋转 90 度。

---

## 变更历史

- **2025-01-08 (Update)**: 废弃了手动堆叠 vbox 的方法，全面转向 LuaTeX 原生 `dir RTT` 方案。验证成功。
