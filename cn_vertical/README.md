# cn_vertical - 中文竖排包

这是一个用于 LuaTeX 的中文竖排包，采用**基于网格的坐标映射**方案，实现精准、灵活的传统中文竖道排版。

---

## 目录

- [快速开始](#快速开始)
- [实现原理](#实现原理)
- [参数说明](#参数说明)
- [更新日志](#更新日志)

---

## 快速开始

### 最简单的例子

```latex
\documentclass{article}
\usepackage{fontspec}
\setmainfont{TW-Kai} % 建议使用支持 vert 特性的字体
\usepackage{cn_vertical}

\begin{document}

\section{竖排演示}

\VerticalRTT[height=300pt, grid-width=25pt, grid-height=20pt, border=true]{
    天地玄黄，宇宙洪荒。日月盈昃，辰宿列张。
    
    （空行会被视为强制换行并开启新的一列）
    
    寒来暑往，秋收冬藏。闰余成岁，律吕调阳。
}

\end{document}
```

---

## 实现原理

本包摒弃了复杂的底层排版引擎修改，采用 LuaTeX 的 Lua 接口进行坐标接管：

1.  **捕获结构**：使用 `\vbox` 捕获文本，保留段落（即强制换行）信息。
2.  **节点展平**：通过 Lua 遍历整个盒子，提取所有字符节点。
3.  **网格映射**：
    - 在内存中构建一个虚拟网格。
    - 将文字按“先列后行”的顺序填入格子中。
    - 当遇到 `\par`（空行）时，即使当前列未满，也会强制跳转到下一列。
4.  **坐标重置**：手动修改每个节点的 `xoffset` 和 `yoffset`，实现精确的 RTL（从右到左）和竖排对齐。

详情请参阅 [VERTICAL_IMPLEMENTATION.md](VERTICAL_IMPLEMENTATION.md)。

---

## 参数说明

`\VerticalRTT` 命令支持以下键值对参数：

| 参数键 | 说明 | 默认值 |
| :--- | :--- | :--- |
| `height` | 竖排块显示的总高度（长度单位）。 | 自动（由 `grid-height` 计算） |
| `grid-width` | 每个网格格子的宽度（列间距）。 | `1.5em` |
| `grid-height` | 每个网格格子的高度（字间距）。 | `1.2em` |
| `cols` | 每一列容纳的最大字符数。若为 0，则根据 `height` 自动计算。 | `0` |
| `debug` | 布尔值，是否显示蓝色的字符对齐调试网格。 | `false` |
| `border` | 布尔值，是否显示传统的黑色“乌丝栏”边框。 | `false` |
| `border-padding` | 边框底部的额外边距。 | `0.2em` |

---

## 更新日志

### v0.4.0 (当前)
- **新特性**：支持通过空行进行**强制换行**（段落换行）。
- **重构**：采用 `\vbox` 捕获 + Lua 节点展平技术，极大提升了排版的稳健性。
- **修复**：解决了在大规模文本排版下的内存管理和盒子溢出问题。

### v0.3.0
- 实现基于网格的坐标映射系统。
- 引入 `debug` 网格和 `border` 乌丝栏功能。

### v0.2.0
- 初始的 RTT 模式探索。
