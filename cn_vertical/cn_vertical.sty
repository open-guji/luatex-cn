% cn_vertical.sty
% Chinese vertical typesetting package for LuaTeX  
% This is a sub-package of luatex_cn
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn_vertical}[2025/01/08 v0.2.0 Chinese vertical typesetting for LuaTeX]

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{cn_vertical}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX.}
\fi

% Load the Lua module using kpse
\directlua{
  local path = kpse.find_file('cn_vertical.lua', 'lua')
  if path then
    texio.write_nl('Loading cn_vertical.lua from: ' .. path)
    dofile(path)
  else
    local f = io.open('cn_vertical.lua')
    if f then
      f:close()
      texio.write_nl('Loading cn_vertical.lua from current directory')
      dofile('cn_vertical.lua')
    else
      texio.write_nl('ERROR: Cannot find cn_vertical.lua')
      tex.error('Fatal error: cn_vertical.lua not found!')
    end
  end
  texio.write_nl('cn_vertical: Module initialized')
}

% Define a simple command for vertical text
\newcommand{\verticaltext}[1]{%
  \par\noindent
  \addfontfeatures{RawFeature=+vert}%
  \directlua{cn_vertical.split_to_vbox([===[#1]===])}%
  \par
}

% Define the vertical environment
\newenvironment{vertical}
  {%
    \par\noindent
    \addfontfeatures{RawFeature=+vert}%
    \directlua{cn_vertical.split_to_vbox([===[%
  }
  {%
    ]===])}%
    \par
  }

% Package information
\PackageInfo{cn_vertical}{Chinese vertical typesetting package loaded}

\endinput
