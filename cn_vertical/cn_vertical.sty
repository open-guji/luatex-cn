% cn_vertical.sty
% Chinese vertical typesetting package for LuaTeX
% This is a sub-package of luatex_cn
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn_vertical}[2025/01/08 v0.1.0 Chinese vertical typesetting for LuaTeX]

% Load expl3 for consistent syntax with main package
\RequirePackage{expl3}
\ExplSyntaxOn

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{cn_vertical}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX.}
\fi

% Load luatexbase for callback management
\RequirePackage{luatexbase}

% Load currfile to get current file directory
\RequirePackage{currfile}

% Package option: enable or disable vertical typesetting
\bool_new:N \l_cnvertical_enabled_bool
\bool_set_true:N \l_cnvertical_enabled_bool

\DeclareOption{disable}
  {
    \bool_set_false:N \l_cnvertical_enabled_bool
  }

\ProcessOptions\relax

\ExplSyntaxOff

% Load the Lua module
% Use kpse to search in the input path
\directlua{
  local kpse = require("kpse")

  % Add the current directory and parent directories to the search path
  kpse.set_program_name("luatex")

  % Try to find cn_vertical.lua using kpse
  local lua_file = kpse.find_file("cn_vertical.lua")

  if lua_file then
    texio.write_nl("term and log", "Loading cn_vertical.lua from: " .. lua_file)
    dofile(lua_file)
    if cn_vertical and cn_vertical.init then
      cn_vertical.init()
    else
      texio.write_nl("term and log", "Error: cn_vertical module not properly initialized")
    end
  else
    texio.write_nl("term and log", "Error: Cannot find cn_vertical.lua in search path")
  end
}

% Define the vertical environment for Chinese vertical typesetting
% Check if vertical environment already exists
\@ifundefined{vertical}{%
  \newenvironment{vertical}
    {%
      \par
      % Call Lua function to enable vertical mode
      \directlua{
        if cn_vertical and cn_vertical.begin_vertical then
          cn_vertical.begin_vertical()
        end
      }%
    }
    {%
      % Call Lua function to disable vertical mode
      \directlua{
        if cn_vertical and cn_vertical.end_vertical then
          cn_vertical.end_vertical()
        end
      }%
      \par
    }
}{%
  \PackageWarning{cn_vertical}{vertical environment already defined, skipping}
}

\ExplSyntaxOn

% Define user command for vertical text
\bool_if:NT \l_cnvertical_enabled_bool
  {
    \cs_new_protected:Npn \cnvertical_text:n #1
      {
        \begin{vertical} #1 \end{vertical}
      }
    \cs_new_eq:NN \verticaltext \cnvertical_text:n
  }

\ExplSyntaxOff

% Package information
\PackageInfo{cn_vertical}{Chinese vertical typesetting package loaded}

\endinput
