% cn_vertical.sty
% Chinese vertical typesetting package for LuaTeX  
% This is a sub-package of luatex_cn
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn_vertical}[2025/01/08 v0.2.0 Chinese vertical typesetting for LuaTeX]

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{cn_vertical}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX.}
\fi

% Load the Lua module using kpse
% Load the Lua module using kpse
% Load the Lua module using kpse
\directlua{
  local path = kpse.find_file('cn_vertical.lua', 'lua')
  if path then
    dofile(path)
  else
    local f = io.open('cn_vertical.lua')
    if f then
      f:close()
      dofile('cn_vertical.lua')
    else
      tex.error('Fatal error: cn_vertical.lua not found!')
    end
  end
}

% Use l3keys for key-value parameters
\RequirePackage{xparse}

\ExplSyntaxOn

% Define keys
\keys_define:nn { cn_vertical }
  {
    height .tl_set:N = \l__cn_vertical_height_tl,
    height .initial:n = , 
    
    spacing-col .tl_set:N = \l__cn_vertical_col_spacing_tl,
    spacing-col .initial:n = {},
    
    spacing-char .int_set:N = \l__cn_vertical_char_spacing_int,
    spacing-char .initial:n = 20,
  }

% Internal function to call Lua
\cs_new:Npn \__cn_vertical_run:n #1
  {
    \directlua{
      cn_vertical.vertical_rtt(
        "\luaescapestring{#1}", 
        "\luaescapestring{\l__cn_vertical_height_tl}",
        "\luaescapestring{\l__cn_vertical_col_spacing_tl}",
        \int_use:N \l__cn_vertical_char_spacing_int
      )
    }
  }

% Define Main Command with Key-Value interface
% Syntax: \VerticalRTT[key=val]{text}
\NewDocumentCommand{\VerticalRTT}{ O{} +m }
  {
    \par
    \group_begin:
    \keys_set:nn { cn_vertical } { #1 }
    \__cn_vertical_run:n { #2 }
    \group_end:
  }

% Alias
\NewDocumentCommand{\vertical}{ O{} +m }
  {
    \VerticalRTT[#1]{#2}
  }

\ExplSyntaxOff

\endinput
