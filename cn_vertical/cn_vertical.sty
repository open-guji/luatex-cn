% cn_vertical.sty
% Chinese vertical typesetting package for LuaTeX
% This is a sub-package of luatex_cn
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn_vertical}[2026/01/12 v0.3.0 Chinese vertical typesetting for LuaTeX (Modularized)]

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{cn_vertical}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX.}
\fi

% Load luatexbase for attributes
\RequirePackage{luatexbase}
\RequirePackage{xcolor}
\newluatexattribute\cnverticalindent
\newluatexattribute\cnverticalrightindent
\newluatexattribute\cnverticaltextboxwidth
\newluatexattribute\cnverticaltextboxheight
\newluatexattribute\cnverticaltextboxdistribute

% Load the Lua modules
% Split into multiple directlua blocks for better error reporting

% Clear cache
\directlua{
  package.loaded["constants"] = nil
  package.loaded["flatten"] = nil
  package.loaded["layout"] = nil
  package.loaded["render"] = nil
  package.loaded["banxin"] = nil
  package.loaded["text_position"] = nil
  package.loaded["core"] = nil
}

% Load constants
\directlua{
  cn_vertical_constants = dofile("constants.lua")
}

% Load flatten
\directlua{
  cn_vertical_flatten = dofile("flatten.lua")
}

% Load layout
\directlua{
  cn_vertical_layout = dofile("layout.lua")
}

% Load text_position (unified text positioning)
\directlua{
  cn_vertical_text_position = dofile("text_position.lua")
}

% Load render
\directlua{
  cn_vertical_render = dofile("render.lua")
}

% Load banxin
\directlua{
  cn_vertical_banxin = dofile("banxin.lua")
}

% Load main module
\directlua{
  cn_vertical = dofile("core.lua")
}

% Use l3keys for key-value parameters
\RequirePackage{xparse}

\ExplSyntaxOn

\tl_new:N \l_cnv_banxin_one_tl
\tl_new:N \l_cnv_banxin_two_tl
\tl_new:N \l_cnv_banxin_three_tl

% Define keys
\keys_define:nn { cn_vertical }
  {
    height .tl_set:N = \l__cn_vertical_height_tl,
    height .initial:n = ,

    spacing-col .tl_set:N = \l__cn_vertical_col_spacing_tl,
    spacing-col .initial:n = {},

    grid-width .tl_set:N = \l__cn_vertical_grid_width_tl,
    grid-width .initial:n = {1.5em},

    grid-height .tl_set:N = \l__cn_vertical_grid_height_tl,
    grid-height .initial:n = {1.2em},

    cols .int_set:N = \l__cn_vertical_cols_int,
    cols .initial:n = 0,

    debug .bool_set:N = \l__cn_vertical_debug_bool,
    debug .initial:n = false,

    border .bool_set:N = \l__cn_vertical_border_bool,
    border .initial:n = false,

    outer-border .bool_set:N = \l__cn_vertical_outer_border_bool,
    outer-border .initial:n = false,

    outer-border-thickness .tl_set:N = \l__cn_vertical_outer_border_thickness_tl,
    outer-border-thickness .initial:n = {2pt},

    outer-border-sep .tl_set:N = \l__cn_vertical_outer_border_sep_tl,
    outer-border-sep .initial:n = {2pt},

    border-padding-top .tl_set:N = \l__cn_vertical_border_padding_top_tl,
    border-padding-top .initial:n = {0.1em},

    border-padding-bottom .tl_set:N = \l__cn_vertical_border_padding_bottom_tl,
    border-padding-bottom .initial:n = {0.1em},

    % Keep for backward compatibility
    border-padding .tl_set:N = \l__cn_vertical_border_padding_bottom_tl,

    border-thickness .tl_set:N = \l__cn_vertical_border_thickness_tl,
    border-thickness .initial:n = {0.4pt},

    vertical-align .tl_set:N = \l__cn_vertical_valign_tl,
    vertical-align .initial:n = {center},

    n-column .int_set:N = \l__cn_vertical_n_column_int,
    n-column .initial:n = 8,

    page-columns .tl_set:N = \l__cn_vertical_page_columns_tl,
    page-columns .initial:n = {},

    border-color .tl_set:N = \l__cn_vertical_border_color_tl,
    border-color .initial:n = {black},

    background-color .tl_set:N = \l__cn_vertical_background_color_tl,
    background-color .initial:n = {},

    font-color .tl_set:N = \l__cn_vertical_font_color_tl,
    font-color .initial:n = {},

    paper-width .tl_set:N = \l__cn_vertical_paper_width_tl,
    paper-width .initial:n = {0pt},

    paper-height .tl_set:N = \l__cn_vertical_paper_height_tl,
    paper-height .initial:n = {0pt},

    margin-top .tl_set:N = \l__cn_vertical_margin_top_tl,
    margin-top .initial:n = {0pt},

    margin-bottom .tl_set:N = \l__cn_vertical_margin_bottom_tl,
    margin-bottom .initial:n = {0pt},

    margin-left .tl_set:N = \l__cn_vertical_margin_left_tl,
    margin-left .initial:n = {0pt},

    margin-right .tl_set:N = \l__cn_vertical_margin_right_tl,
    margin-right .initial:n = {0pt},

    % Banxin (版心) configuration
    banxin-section1-ratio .tl_set:N = \l_cnv_banxin_one_tl,
    banxin-section1-ratio .initial:n = {0.28},

    banxin-section2-ratio .tl_set:N = \l_cnv_banxin_two_tl,
    banxin-section2-ratio .initial:n = {0.56},

    banxin-section3-ratio .tl_set:N = \l_cnv_banxin_three_tl,
    banxin-section3-ratio .initial:n = {0.16},

    % Banxin text (鱼尾文字)
    banxin-text .tl_set:N = \l_cnv_banxin_text_tl,
    banxin-text .initial:n = {},
  }

\tl_new:N \l__cn_vertical_border_rgb_tl
\tl_new:N \l__cn_vertical_background_rgb_tl
\tl_new:N \l__cn_vertical_font_rgb_tl

% Internal function to call Lua for Grid Layout
\cs_new:Npn \__cn_vertical_process_grid:n #1
  {
    % Put content into a vbox to preserve structure (paragraphs)
    \setbox0=\vbox{\hsize=10000pt \parindent=0pt #1}
    % Call Lua to transform the box
    \setlength{\topskip}{0pt}
    
    % Support direct RGB input (e.g. 0.1 0.2 0.3 or 0.1,0.2,0.3 or 100,50,0)
    \tl_if_in:NnTF \l__cn_vertical_border_color_tl { , }
      { \tl_set_eq:NN \l__cn_vertical_border_rgb_tl \l__cn_vertical_border_color_tl }
      {
        \tl_if_in:NnTF \l__cn_vertical_border_color_tl { ~ }
          { \tl_set_eq:NN \l__cn_vertical_border_rgb_tl \l__cn_vertical_border_color_tl }
          {
             % Try extraction, but wrap in safety
             \cs_if_exist:cTF { \string color @ \l__cn_vertical_border_color_tl }
             {
               \exp_args:NV \extractcolorspec \l__cn_vertical_border_color_tl \l_tmpa_tl
               \exp_args:NNx \convertcolorspec \l_tmpa_tl {rgb} \l_tmpb_tl
               \tl_set:Nx \l__cn_vertical_border_rgb_tl { \l_tmpb_tl }
             }
             { \tl_set_eq:NN \l__cn_vertical_border_rgb_tl \l__cn_vertical_border_color_tl }
          }
      }
    \tl_replace_all:Nnn \l__cn_vertical_border_rgb_tl { , } { ~ }

    \tl_if_empty:NTF \l__cn_vertical_background_color_tl
      { \tl_set:Nn \l__cn_vertical_background_rgb_tl { nil } }
      {
        \tl_if_in:NnTF \l__cn_vertical_background_color_tl { , }
          { \tl_set_eq:NN \l__cn_vertical_background_rgb_tl \l__cn_vertical_background_color_tl }
          {
            \tl_if_in:NnTF \l__cn_vertical_background_color_tl { ~ }
              { \tl_set_eq:NN \l__cn_vertical_background_rgb_tl \l__cn_vertical_background_color_tl }
              {
                 \cs_if_exist:cTF { \string color @ \l__cn_vertical_background_color_tl }
                 {
                   \exp_args:NV \extractcolorspec \l__cn_vertical_background_color_tl \l_tmpa_tl
                   \exp_args:NNx \convertcolorspec \l_tmpa_tl {rgb} \l_tmpb_tl
                   \tl_set:Nx \l__cn_vertical_background_rgb_tl { \l_tmpb_tl }
                 }
                 { \tl_set_eq:NN \l__cn_vertical_background_rgb_tl \l__cn_vertical_background_color_tl }
              }
          }
      }
    \tl_replace_all:Nnn \l__cn_vertical_background_rgb_tl { , } { ~ }

    \tl_if_empty:NTF \l__cn_vertical_font_color_tl
      { \tl_set:Nn \l__cn_vertical_font_rgb_tl { nil } }
      {
        \tl_if_in:NnTF \l__cn_vertical_font_color_tl { , }
          { \tl_set_eq:NN \l__cn_vertical_font_rgb_tl \l__cn_vertical_font_color_tl }
          {
            \tl_if_in:NnTF \l__cn_vertical_font_color_tl { ~ }
              { \tl_set_eq:NN \l__cn_vertical_font_rgb_tl \l__cn_vertical_font_color_tl }
              {
                 \cs_if_exist:cTF { \string color @ \l__cn_vertical_font_color_tl }
                 {
                   \exp_args:NV \extractcolorspec \l__cn_vertical_font_color_tl \l_tmpa_tl
                   \exp_args:NNx \convertcolorspec \l_tmpa_tl {rgb} \l_tmpb_tl
                   \tl_set:Nx \l__cn_vertical_font_rgb_tl { \l_tmpb_tl }
                 }
                 { \tl_set_eq:NN \l__cn_vertical_font_rgb_tl \l__cn_vertical_font_color_tl }
              }
          }
      }
    \tl_replace_all:Nnn \l__cn_vertical_font_rgb_tl { , } { ~ }

    \directlua{
      cn_vertical.process_from_tex(0, {
        height = [=[\luaescapestring{\l__cn_vertical_height_tl}]=],
        grid_width = [=[\luaescapestring{\l__cn_vertical_grid_width_tl}]=],
        grid_height = [=[\luaescapestring{\l__cn_vertical_grid_height_tl}]=],
        col_limit = \int_use:N \l__cn_vertical_cols_int,
        debug_on = [=[\bool_if:NTF \l__cn_vertical_debug_bool {true} {false}]=],
        border_on = [=[\bool_if:NTF \l__cn_vertical_border_bool {true} {false}]=],
        border_padding_top = [=[\luaescapestring{\l__cn_vertical_border_padding_top_tl}]=],
        border_padding_bottom = [=[\luaescapestring{\l__cn_vertical_border_padding_bottom_tl}]=],
        vertical_align = [=[\luaescapestring{\l__cn_vertical_valign_tl}]=],
        border_thickness = [=[\luaescapestring{\l__cn_vertical_border_thickness_tl}]=],
        outer_border_on = [=[\bool_if:NTF \l__cn_vertical_outer_border_bool {true} {false}]=],
        outer_border_thickness = [=[\luaescapestring{\l__cn_vertical_outer_border_thickness_tl}]=],
        outer_border_sep = [=[\luaescapestring{\l__cn_vertical_outer_border_sep_tl}]=],
        n_column = \int_use:N \l__cn_vertical_n_column_int,
        page_columns = [=[\luaescapestring{\l__cn_vertical_page_columns_tl}]=],
        border_color = [=[\l__cn_vertical_border_rgb_tl]=],
        background_color = [=[\l__cn_vertical_background_rgb_tl]=],
        font_color = [=[\l__cn_vertical_font_rgb_tl]=],
        paper_width = [=[\luaescapestring{\l__cn_vertical_paper_width_tl}]=],
        paper_height = [=[\luaescapestring{\l__cn_vertical_paper_height_tl}]=],
        margin_top = [=[\luaescapestring{\l__cn_vertical_margin_top_tl}]=],
        margin_bottom = [=[\luaescapestring{\l__cn_vertical_margin_bottom_tl}]=],
        margin_left = [=[\luaescapestring{\l__cn_vertical_margin_left_tl}]=],
        margin_right = [=[\luaescapestring{\l__cn_vertical_margin_right_tl}]=],
        banxin_s1_ratio = [=[\luaescapestring{\l_cnv_banxin_one_tl}]=],
        banxin_s2_ratio = [=[\luaescapestring{\l_cnv_banxin_two_tl}]=],
        banxin_s3_ratio = [=[\luaescapestring{\l_cnv_banxin_three_tl}]=],
        banxin_text = [=[\luaescapestring{\l_cnv_banxin_text_tl}]=]
      })
    }
  }

% Define Main Command with Key-Value interface
% Syntax: \VerticalRTT[key=val]{text}
\NewDocumentCommand{\VerticalRTT}{ O{} +m }
  {
    \par\noindent
    \group_begin:
    \keys_set:nn { cn_vertical } { #1 }
    \__cn_vertical_process_grid:n { #2 }
    \group_end:
  }

% Alias
\NewDocumentCommand{\vertical}{ O{} +m }
  {
    \VerticalRTT[#1]{#2}
  }

% Grid Textbox Command
% Syntax: \GridTextbox[width][height]{content}
% width and height are in grid units (integers)
% Key-value interface for \GridTextbox
\keys_define:nn { cn_vertical / textbox }
  {
    width .int_set:N = \l__cn_vertical_textbox_width_int,
    width .initial:n = 1,
    height .int_set:N = \l__cn_vertical_textbox_height_int,
    height .initial:n = 1,
    distribute .bool_set:N = \l__cn_vertical_textbox_distribute_bool,
    distribute .initial:n = false,
  }

\NewDocumentCommand{\GridTextbox}{ O{} +m }
  {
    \group_begin:
    \keys_set:nn { cn_vertical / textbox } { #1 }
    \setluatexattribute\cnverticaltextboxwidth{\l__cn_vertical_textbox_width_int}
    \setluatexattribute\cnverticaltextboxheight{\l__cn_vertical_textbox_height_int}
    % Capture content in a box and process it via Lua for inner verticality
    \setbox0=\vbox{
      \setluatexattribute\cnverticaltextboxwidth{0}
      \setluatexattribute\cnverticaltextboxheight{0}
      % Inner line length should be the grid height of the block
      \hsize=\dim_eval:n { \l__cn_vertical_grid_height_tl * \int_use:N \l__cn_vertical_textbox_height_int }
      #2
    }
    \directlua{cn_vertical.verticalize_inner_box(0, 
      \int_use:N \l__cn_vertical_textbox_width_int, 
      \int_use:N \l__cn_vertical_textbox_height_int, 
      "\dim_to_decimal:n { \l__cn_vertical_grid_width_tl } pt", 
      "\dim_to_decimal:n { \l__cn_vertical_grid_height_tl } pt", 
      "\luaescapestring{\tl_use:N \l__cn_vertical_valign_tl}", 
      "\bool_if:NTF \l__cn_vertical_textbox_distribute_bool {true}{false}",
      "\bool_if:NTF \l__cn_vertical_debug_bool {true}{false}",
      "\bool_if:NTF \l__cn_vertical_border_bool {true}{false}"
    )}
    \box0
    \group_end:
  }

\ExplSyntaxOff

\endinput
