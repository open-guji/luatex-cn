% cn_vertical.sty
% Chinese vertical typesetting package for LuaTeX  
% This is a sub-package of luatex_cn
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn_vertical}[2025/01/08 v0.2.0 Chinese vertical typesetting for LuaTeX]

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{cn_vertical}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX.}
\fi

\RequirePackage{luatexbase}
\newluatexattribute\cnverticalindent
\newluatexattribute\cnverticalrightindent

% Load the Lua module using kpse and setup package.path for require()
\directlua{
  -- Configure Lua module search path to support require()
  -- This allows cn_vertical.lua to load its submodules using require()
  local function setup_lua_path()
    -- Add TEXMF tree script paths
    local texmf_scripts = kpse.expand_path('$TEXMFHOME') .. '/scripts/?.lua;' ..
                         kpse.expand_path('$TEXMFDIST') .. '/scripts/?.lua'
    package.path = package.path .. ';' .. texmf_scripts

    -- Add current working directory
    package.path = package.path .. ';./?.lua'

    -- Find cn_vertical.lua using kpse and add its directory to package.path
    -- This is critical for require() to find the submodules
    local cn_vert_path = kpse.find_file('cn_vertical.lua', 'lua')
    if cn_vert_path then
      -- Extract directory from full path
      -- Handle both Unix (/) and Windows (backslash) path separators
      -- Normalize path by replacing backslashes with forward slashes
      cn_vert_path = cn_vert_path:gsub('\\', '/')
      local dir = cn_vert_path:match('(.*/)')
      if dir then
        package.path = package.path .. ';' .. dir .. '?.lua'
      end
    end
  end

  -- Setup the path first
  setup_lua_path()

  -- Debug: print package.path
  -- texio.write_nl('term and log', 'DEBUG: package.path = ' .. package.path)

  -- Load the main module using require (which will auto-load submodules)
  -- require() provides better module caching than dofile()
  local ok, result = pcall(require, 'cn_vertical')
  if not ok then
    texio.write_nl('term and log', 'WARNING: require failed with error: ' .. tostring(result))
    texio.write_nl('term and log', 'Falling back to dofile...')
    -- Fallback: try direct dofile for backward compatibility
    local path = kpse.find_file('cn_vertical.lua', 'lua')
    if path then
      dofile(path)
    else
      local f = io.open('cn_vertical.lua')
      if f then
        f:close()
        dofile('cn_vertical.lua')
      else
        tex.error('Fatal error: cn_vertical.lua not found! Error: ' .. tostring(result))
      end
    end
  else
    -- SUCCESS: require() returned the module
    -- But we need to ensure cn_vertical is set as a global variable
    -- In case it's not already set by the module itself
    if not cn_vertical then
      cn_vertical = result
    end
    texio.write_nl('term and log', 'SUCCESS: cn_vertical loaded via require()')
  end
}

% Use l3keys for key-value parameters
\RequirePackage{xparse}

\ExplSyntaxOn

% Define keys
\keys_define:nn { cn_vertical }
  {
    height .tl_set:N = \l__cn_vertical_height_tl,
    height .initial:n = , 
    
    spacing-col .tl_set:N = \l__cn_vertical_col_spacing_tl,
    spacing-col .initial:n = {},
    
    grid-width .tl_set:N = \l__cn_vertical_grid_width_tl,
    grid-width .initial:n = {1.5em},

    grid-height .tl_set:N = \l__cn_vertical_grid_height_tl,
    grid-height .initial:n = {1.2em},

    cols .int_set:N = \l__cn_vertical_cols_int,
    cols .initial:n = 0,

    debug .bool_set:N = \l__cn_vertical_debug_bool,
    debug .initial:n = false,

    border .bool_set:N = \l__cn_vertical_border_bool,
    border .initial:n = false,

    border-padding .tl_set:N = \l__cn_vertical_border_padding_tl,
    border-padding .initial:n = {0.2em},

    vertical-align .tl_set:N = \l__cn_vertical_valign_tl,
    vertical-align .initial:n = {center},
  }

% Internal function to call Lua
% Internal function to call Lua for Grid Layout
\cs_new:Npn \__cn_vertical_process_grid:n #1
  {
    % Put content into a vbox to preserve structure (paragraphs)
    \setbox0=\vbox{\hsize=10000pt \parindent=0pt #1}
    % Call Lua to transform the box
    \directlua{
      cn_vertical.make_grid_box(
        0,
        "\luaescapestring{\l__cn_vertical_height_tl}",
        "\luaescapestring{\l__cn_vertical_grid_width_tl}",
        "\luaescapestring{\l__cn_vertical_grid_height_tl}",
        \int_use:N \l__cn_vertical_cols_int,
        "\bool_if:NTF \l__cn_vertical_debug_bool {true} {false}",
        "\bool_if:NTF \l__cn_vertical_border_bool {true} {false}",
        "\luaescapestring{\l__cn_vertical_border_padding_tl}",
        "\luaescapestring{\l__cn_vertical_valign_tl}"
      )
    }
    % Output the modified box (RTL layout handled internally)
    \noindent\hfill\box0
  }

% Define Main Command with Key-Value interface
% Syntax: \VerticalRTT[key=val]{text}
\NewDocumentCommand{\VerticalRTT}{ O{} +m }
  {
    \par\noindent
    \group_begin:
    \keys_set:nn { cn_vertical } { #1 }
    \__cn_vertical_process_grid:n { #2 }
    \group_end:
  }

% Alias
\NewDocumentCommand{\vertical}{ O{} +m }
  {
    \VerticalRTT[#1]{#2}
  }

\ExplSyntaxOff

\endinput
