% cn_vertical.sty
% Chinese vertical typesetting package for LuaTeX
% This is a sub-package of luatex_cn
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn_vertical}[2026/01/12 v0.3.0 Chinese vertical typesetting for LuaTeX (Modularized)]

\typeout{==== cn_vertical.sty v0.3.0 (Modularized) is being loaded ====}

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{cn_vertical}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX.}
\fi

\RequirePackage{luatexbase}
\newluatexattribute\cnverticalindent
\newluatexattribute\cnverticalrightindent

\typeout{==== BEFORE DIRECTLUA BLOCK ====}

% Load the Lua modules using dofile with proper package.loaded sync
\directlua{
  -- FORCE CLEAR CACHE (Crucial for development)
  package.loaded["cn_vertical"] = nil
  package.loaded["cn_vertical_constants"] = nil
  package.loaded["cn_vertical_flatten"] = nil
  package.loaded["cn_vertical_layout"] = nil
  package.loaded["cn_vertical_render"] = nil

  -- Simple helper to load and register one module
  local function load_one(modname, filename)
    local path = kpse.find_file(filename, "lua")
    if not path then path = filename end

    local ok, result = pcall(dofile, path)
    if not ok then
      tex.error("Failed to load " .. filename .. ": " .. tostring(result))
      return false
    end

    if result then
      package.loaded[modname] = result
    end
    return true
  end

  -- Load each module explicitly
  if not load_one("cn_vertical_constants", "cn_vertical_constants.lua") then
    tex.error("Cannot load cn_vertical_constants.lua")
  end

  if not load_one("cn_vertical_flatten", "cn_vertical_flatten.lua") then
    tex.error("Cannot load cn_vertical_flatten.lua")
  end

  if not load_one("cn_vertical_layout", "cn_vertical_layout.lua") then
    tex.error("Cannot load cn_vertical_layout.lua")
  end

  if not load_one("cn_vertical_render", "cn_vertical_render.lua") then
    tex.error("Cannot load cn_vertical_render.lua")
  end

  if not load_one("cn_vertical", "cn_vertical_main.lua") then
    tex.error("Cannot load cn_vertical_main.lua")
  end

  -- Final check: make sure cn_vertical global is set
  if not cn_vertical then
    -- Try to get from package.loaded
    cn_vertical = package.loaded["cn_vertical"]
  end

  if not cn_vertical or not cn_vertical.make_grid_box then
    tex.error("FAILED! cn_vertical=" .. tostring(cn_vertical) .. " package.loaded=" .. tostring(package.loaded["cn_vertical"]))
  end
}

\typeout{==== AFTER DIRECTLUA BLOCK ====}

% Use l3keys for key-value parameters
\RequirePackage{xparse}

\ExplSyntaxOn

% Define keys
\keys_define:nn { cn_vertical }
  {
    height .tl_set:N = \l__cn_vertical_height_tl,
    height .initial:n = ,

    spacing-col .tl_set:N = \l__cn_vertical_col_spacing_tl,
    spacing-col .initial:n = {},

    grid-width .tl_set:N = \l__cn_vertical_grid_width_tl,
    grid-width .initial:n = {1.5em},

    grid-height .tl_set:N = \l__cn_vertical_grid_height_tl,
    grid-height .initial:n = {1.2em},

    cols .int_set:N = \l__cn_vertical_cols_int,
    cols .initial:n = 0,

    debug .bool_set:N = \l__cn_vertical_debug_bool,
    debug .initial:n = false,

    border .bool_set:N = \l__cn_vertical_border_bool,
    border .initial:n = false,

    border-padding .tl_set:N = \l__cn_vertical_border_padding_tl,
    border-padding .initial:n = {0.2em},

    vertical-align .tl_set:N = \l__cn_vertical_valign_tl,
    vertical-align .initial:n = {center},
  }

% Internal function to call Lua for Grid Layout
\cs_new:Npn \__cn_vertical_process_grid:n #1
  {
    % Put content into a vbox to preserve structure (paragraphs)
    \setbox0=\vbox{\hsize=10000pt \parindent=0pt #1}
    % Call Lua to transform the box
    \directlua{
      cn_vertical.make_grid_box(
        0,
        "\luaescapestring{\l__cn_vertical_height_tl}",
        "\luaescapestring{\l__cn_vertical_grid_width_tl}",
        "\luaescapestring{\l__cn_vertical_grid_height_tl}",
        \int_use:N \l__cn_vertical_cols_int,
        "\bool_if:NTF \l__cn_vertical_debug_bool {true} {false}",
        "\bool_if:NTF \l__cn_vertical_border_bool {true} {false}",
        "\luaescapestring{\l__cn_vertical_border_padding_tl}",
        "\luaescapestring{\l__cn_vertical_valign_tl}"
      )
    }
    % Output the modified box (RTL layout handled internally)
    \noindent\hfill\box0
  }

% Define Main Command with Key-Value interface
% Syntax: \VerticalRTT[key=val]{text}
\NewDocumentCommand{\VerticalRTT}{ O{} +m }
  {
    \par\noindent
    \group_begin:
    \keys_set:nn { cn_vertical } { #1 }
    \__cn_vertical_process_grid:n { #2 }
    \group_end:
  }

% Alias
\NewDocumentCommand{\vertical}{ O{} +m }
  {
    \VerticalRTT[#1]{#2}
  }

\ExplSyntaxOff

\endinput
