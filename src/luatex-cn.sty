% luatex-cn.sty
% LuaTeX package for Chinese character and vertical typesetting support
% This package uses expl3 (LaTeX3 programming layer)
% 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luatex-cn}[2025/01/08 v0.1.0 Chinese and vertical typesetting support for LuaTeX]

% Load expl3 (LaTeX3 programming layer)
% This package follows expl3 naming conventions:
% - Variables: \g_luatexcn_name_type (global), \l_luatexcn_name_type (local)
% - Functions: \luatexcn_function_name:arg_spec
% - Lua functions: module.function_name (using underscores)
\RequirePackage{expl3}
\ExplSyntaxOn

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{luatex-cn}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX instead of pdfLaTeX or XeLaTeX.}
\fi

% Load required packages
\RequirePackage{luatexja}
\RequirePackage{luatexja-fontspec}
\RequirePackage{luatexja-otf}

% Package options using expl3 booleans
\bool_new:N \g_luatexcn_vertical_bool
\bool_new:N \g_luatexcn_traditional_bool
\bool_new:N \g_luatexcn_simplified_bool

% Default: simplified Chinese
\bool_set_true:N \g_luatexcn_simplified_bool

% Define package options
\DeclareOption{vertical}
  {
    \bool_set_true:N \g_luatexcn_vertical_bool
  }
\DeclareOption{traditional}
  {
    \bool_set_true:N \g_luatexcn_traditional_bool
    \bool_set_false:N \g_luatexcn_simplified_bool
  }
\DeclareOption{simplified}
  {
    \bool_set_true:N \g_luatexcn_simplified_bool
    \bool_set_false:N \g_luatexcn_traditional_bool
  }

\ProcessOptions\relax

% Load Lua scripts for advanced features
% Initialize luatexcn namespace
\directlua{
  luatexcn = luatexcn or {}
  -- Load Lua modules (they should be in the same directory as the .sty file)
  local kpse = kpse or require("kpse")
  kpse.set_program_name("luatex")
  local luatexcn_path = kpse.find_file("luatex-cn-vertical.lua", "lua")
  if luatexcn_path then
    dofile(luatexcn_path)
  end
  luatexcn_path = kpse.find_file("luatex-cn-chinese.lua", "lua")
  if luatexcn_path then
    dofile(luatexcn_path)
  end
}

% Default font settings using expl3 conditionals
\bool_if:NT \g_luatexcn_traditional_bool
  {
    \setmainjfont{Noto Serif CJK TC}[
      UprightFont = *-Regular,
      BoldFont = *-Bold,
    ]
  }
\bool_if:NF \g_luatexcn_traditional_bool
  {
    \setmainjfont{Noto Serif CJK SC}[
      UprightFont = *-Regular,
      BoldFont = *-Bold,
    ]
  }

% Vertical typesetting environment
\bool_if:NT \g_luatexcn_vertical_bool
  {
    \RequirePackage{tate}
  }

% Chinese punctuation spacing adjustments
\directlua{
  luatexcn = luatexcn or {}
  luatexcn.adjust_punctuation = function(head)
    -- Adjust spacing for Chinese punctuation
    return head
  end
}

% Vertical typesetting commands using expl3
\cs_new_protected:Npn \luatexcn_vertical_text:n #1
  {
    \begin{tate} #1 \end{tate}
  }
\cs_new_protected:Npn \luatexcn_chinese_text:n #1
  {
    #1
  }

% User-facing commands
\cs_new_eq:NN \verticaltext \luatexcn_vertical_text:n
\cs_new_eq:NN \chinesetext \luatexcn_chinese_text:n

\ExplSyntaxOff
% End of package
\endinput
