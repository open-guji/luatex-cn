% luatex-cn.sty
% LuaTeX package for Chinese character and vertical typesetting support
% This package uses expl3 (LaTeX3 programming layer)
% 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luatex_cn}[2025/01/08 v0.1.0 Chinese and vertical typesetting support for LuaTeX]

% Load expl3 (LaTeX3 programming layer)
% This package follows expl3 naming conventions:
% - Variables: \g_luatexcn_name_type (global), \l_luatexcn_name_type (local)
% - Functions: \luatexcn_function_name:arg_spec
% - Lua functions: module.function_name (using underscores)
\RequirePackage{expl3}
\ExplSyntaxOn

% Check if LuaTeX is being used
\RequirePackage{ifluatex}
\ifluatex\else
  \PackageError{luatex_cn}{This package requires LuaTeX}{%
    Please compile your document with LuaLaTeX instead of pdfLaTeX or XeLaTeX.}
\fi

% Load required packages
\RequirePackage{luatexja}
\RequirePackage{luatexja-fontspec}
\RequirePackage{luatexja-otf}

% Package options using expl3 booleans
\bool_new:N \g_luatexcn_vertical_bool
\bool_new:N \g_luatexcn_traditional_bool
\bool_new:N \g_luatexcn_simplified_bool

% Default: simplified Chinese
\bool_set_true:N \g_luatexcn_simplified_bool

% Define package options
\DeclareOption{vertical}
  {
    \bool_set_true:N \g_luatexcn_vertical_bool
  }
\DeclareOption{traditional}
  {
    \bool_set_true:N \g_luatexcn_traditional_bool
    \bool_set_false:N \g_luatexcn_simplified_bool
  }
\DeclareOption{simplified}
  {
    \bool_set_true:N \g_luatexcn_simplified_bool
    \bool_set_false:N \g_luatexcn_traditional_bool
  }

\ProcessOptions\relax

% Load Lua scripts for advanced features
% Initialize luatexcn namespace
\directlua{
  if not luatexcn then luatexcn = {} end
  -- Get the directory of the current .sty file
  local kpse = kpse or require("kpse")
  kpse.set_program_name("luatex")

  -- Try to find the .sty file first to get its directory
  local sty_path = kpse.find_file("luatex_cn.sty", "tex")
  local lua_dir = ""

  if sty_path then
    -- Extract directory from the .sty file path
    lua_dir = sty_path:match("(.*[/\\\\])")
  end

  -- Load Lua modules from the same directory as the .sty file
  local vertical_path = lua_dir .. "luatex_cn_vertical.lua"
  local chinese_path = lua_dir .. "luatex_cn_chinese.lua"

  -- Try to load the files
  local vertical_file = io.open(vertical_path, "r")
  if vertical_file then
    vertical_file:close()
    dofile(vertical_path)
  else
    texio.write_nl("Warning: Could not find luatex_cn_vertical.lua")
  end

  local chinese_file = io.open(chinese_path, "r")
  if chinese_file then
    chinese_file:close()
    dofile(chinese_path)
  else
    texio.write_nl("Warning: Could not find luatex_cn_chinese.lua")
  end
}

% Default font settings using expl3 conditionals
\bool_if:NT \g_luatexcn_traditional_bool
  {
    \setmainjfont{Noto Serif CJK TC}[
      UprightFont = *-Regular,
      BoldFont = *-Bold,
    ]
  }
\bool_if:NF \g_luatexcn_traditional_bool
  {
    \setmainjfont{Noto Serif CJK SC}[
      UprightFont = *-Regular,
      BoldFont = *-Bold,
    ]
  }

% Vertical typesetting environment
\bool_if:NT \g_luatexcn_vertical_bool
  {
    \RequirePackage{tate}
  }

% Chinese punctuation spacing adjustments
\directlua{
  if not luatexcn then luatexcn = {} end
  luatexcn.adjust_punctuation = function(head)
    -- Adjust spacing for Chinese punctuation
    return head
  end
}

% Vertical typesetting commands using expl3
\cs_new_protected:Npn \luatexcn_vertical_text:n #1
  {
    \begin{tate} #1 \end{tate}
  }
\cs_new_protected:Npn \luatexcn_chinese_text:n #1
  {
    #1
  }

% User-facing commands
\cs_new_eq:NN \verticaltext \luatexcn_vertical_text:n
\cs_new_eq:NN \chinesetext \luatexcn_chinese_text:n

\ExplSyntaxOff
% End of package
\endinput
