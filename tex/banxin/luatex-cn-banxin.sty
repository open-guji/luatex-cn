% Copyright 2026 Open-Guji (https://github.com/open-guji)
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%     http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
% luatex-cn-banxin.sty
% 古籍版心与鱼尾功能支持
% 这是 luatex_cn 的子包
%
\RequirePackage{expl3}
\RequirePackage{xparse}
\ProvidesExplPackage {banxin/luatex-cn-banxin} {2026/01/31} {0.2.1} {Ancient Book Banxin Support}

\lua_now:e {
  package.loaded["banxin.luatex-cn-banxin-main"]~=~nil;
  banxin~=~require("banxin.luatex-cn-banxin-main");
}

% =============================================================================
% Banxin Key Definitions (luatexcn / banxin namespace)
% All banxin-related parameters are defined here and can be configured via
% \banxinSetup{} or through the luatexcn/vertical forwarding keys
% =============================================================================

% --- Variable Declarations ---
% Banxin on/off
\bool_new:N \l__luatexcn_banxin_on_bool

% Banxin layout ratios
\tl_new:N \l__luatexcn_banxin_upper_ratio_tl
\tl_new:N \l__luatexcn_banxin_middle_ratio_tl

% Banxin padding
\tl_new:N \l__luatexcn_banxin_padding_top_tl
\tl_new:N \l__luatexcn_banxin_padding_bottom_tl

% Banxin divider
\bool_new:N \l__luatexcn_banxin_divider_bool

% Book name
\tl_new:N \l__luatexcn_banxin_book_name_tl
\tl_new:N \l__luatexcn_banxin_book_name_align_tl
\tl_new:N \l__luatexcn_banxin_book_name_grid_height_tl

% Chapter title
\tl_new:N \l__luatexcn_banxin_chapter_title_tl
\tl_new:N \l__luatexcn_banxin_chapter_title_top_margin_tl
\int_new:N \l__luatexcn_banxin_chapter_title_cols_int
\tl_new:N \l__luatexcn_banxin_chapter_title_font_size_tl
\tl_new:N \l__luatexcn_banxin_chapter_title_grid_height_tl

% Yuwei
\bool_new:N \l__luatexcn_banxin_upper_yuwei_bool
\bool_new:N \l__luatexcn_banxin_lower_yuwei_bool

% Page number
\tl_new:N \l__luatexcn_banxin_page_number_align_tl
\tl_new:N \l__luatexcn_banxin_page_number_font_size_tl
\tl_new:N \l__luatexcn_banxin_page_number_grid_height_tl

% Publisher
\tl_new:N \l__luatexcn_banxin_publisher_tl
\tl_new:N \l__luatexcn_banxin_publisher_font_size_tl
\tl_new:N \l__luatexcn_banxin_publisher_grid_height_tl
\tl_new:N \l__luatexcn_banxin_publisher_bottom_margin_tl
\tl_new:N \l__luatexcn_banxin_publisher_align_tl

% --- Key Definitions ---
\keys_define:nn { luatexcn / banxin }
  {
    % Banxin on/off
    banxin .bool_set:N = \l__luatexcn_banxin_on_bool,
    banxin .initial:n = false,

    % Banxin layout ratios
    banxin-upper-ratio .tl_set:N = \l__luatexcn_banxin_upper_ratio_tl,
    banxin-upper-ratio .initial:n = {0.28},

    banxin-middle-ratio .tl_set:N = \l__luatexcn_banxin_middle_ratio_tl,
    banxin-middle-ratio .initial:n = {0.56},

    % Banxin padding
    banxin-padding-top .tl_set:N = \l__luatexcn_banxin_padding_top_tl,
    banxin-padding-top .initial:n = {2pt},

    banxin-padding-bottom .tl_set:N = \l__luatexcn_banxin_padding_bottom_tl,
    banxin-padding-bottom .initial:n = {10pt},

    % Banxin divider
    banxin-divider .bool_set:N = \l__luatexcn_banxin_divider_bool,
    banxin-divider .initial:n = true,

    % Book name
    book-name .tl_set:N = \l__luatexcn_banxin_book_name_tl,
    book-name .initial:n = {},

    book-name-align .tl_set:N = \l__luatexcn_banxin_book_name_align_tl,
    book-name-align .initial:n = {center},

    book-name-grid-height .tl_set:N = \l__luatexcn_banxin_book_name_grid_height_tl,
    book-name-grid-height .initial:n = {},

    % Chapter title
    chapter-title .tl_set:N = \l__luatexcn_banxin_chapter_title_tl,
    chapter-title .initial:n = {},

    chapter-title-top-margin .tl_set:N = \l__luatexcn_banxin_chapter_title_top_margin_tl,
    chapter-title-top-margin .initial:n = {20pt},

    chapter-title-cols .int_set:N = \l__luatexcn_banxin_chapter_title_cols_int,
    chapter-title-cols .initial:n = 1,

    chapter-title-font-size .tl_set:N = \l__luatexcn_banxin_chapter_title_font_size_tl,
    chapter-title-font-size .initial:n = {},

    chapter-title-grid-height .tl_set:N = \l__luatexcn_banxin_chapter_title_grid_height_tl,
    chapter-title-grid-height .initial:n = {},

    % Yuwei
    upper-yuwei .bool_set:N = \l__luatexcn_banxin_upper_yuwei_bool,
    upper-yuwei .initial:n = true,

    lower-yuwei .bool_set:N = \l__luatexcn_banxin_lower_yuwei_bool,
    lower-yuwei .initial:n = true,

    % Page number
    page-number-align .tl_set:N = \l__luatexcn_banxin_page_number_align_tl,
    page-number-align .initial:n = {right-bottom},

    page-number-font-size .tl_set:N = \l__luatexcn_banxin_page_number_font_size_tl,
    page-number-font-size .initial:n = {14pt},

    page-number-grid-height .tl_set:N = \l__luatexcn_banxin_page_number_grid_height_tl,
    page-number-grid-height .initial:n = {},

    % Publisher
    publisher .tl_set:N = \l__luatexcn_banxin_publisher_tl,
    publisher .initial:n = {},

    publisher-font-size .tl_set:N = \l__luatexcn_banxin_publisher_font_size_tl,
    publisher-font-size .initial:n = {10pt},

    publisher-grid-height .tl_set:N = \l__luatexcn_banxin_publisher_grid_height_tl,
    publisher-grid-height .initial:n = {},

    publisher-bottom-margin .tl_set:N = \l__luatexcn_banxin_publisher_bottom_margin_tl,
    publisher-bottom-margin .initial:n = {5pt},

    publisher-align .tl_set:N = \l__luatexcn_banxin_publisher_align_tl,
    publisher-align .initial:n = {right},
  }

% =============================================================================
% Setup Command
% =============================================================================
\NewDocumentCommand{\banxinSetup}{ m }
  {
    \keys_set:nn { luatexcn / banxin } { #1 }
    % Update _G.banxin.enabled for early access by content.setup
    \lua_now:e {
      _G.banxin.setup({
        enabled~=~\bool_if:NTF~\l__luatexcn_banxin_on_bool~{true}~{false}
      })
    }
  }

% =============================================================================
% Compatibility Mode Logic
% =============================================================================

% 1. Book Name / Title Synchronization
\cs_if_exist:NTF \title
  {
    \NewCommandCopy \__luatexcn_banxin_orig_title \title
    \RenewDocumentCommand \title { m }
      {
        \__luatexcn_banxin_orig_title { #1 }
        \keys_set:nn { luatexcn / banxin } { book-name = { #1 } }
      }
  }
  {
    \NewDocumentCommand \title { m }
      {
        \gdef\@title{#1}
        \keys_set:nn { luatexcn / banxin } { book-name = { #1 } }
      }
  }

% Note: Fallback sync from \@title is removed because:
% 1. Document classes (ltc-guji.cls) already redefine \title to set book-name
% 2. LaTeX's default \@title throws an error which breaks \luaescapestring
% If you need automatic sync, use \title{} command before \begin{document}

% 2. Chapter Title Synchronization
\cs_if_exist:NTF \chapter
  {
    \NewCommandCopy \__luatexcn_banxin_orig_chapter \chapter
    \RenewDocumentCommand \chapter { s o m }
      {
        \IfBooleanTF {#1}
          { \__luatexcn_banxin_orig_chapter* {#3} }
          {
            \IfNoValueTF {#2}
              { \__luatexcn_banxin_orig_chapter {#3} }
              { \__luatexcn_banxin_orig_chapter [#2] {#3} }
          }
        \keys_set:nn { luatexcn / banxin } { chapter-title = { #3 } }
      }
  }
  {
    \NewDocumentCommand \chapter { m }
      {
        \keys_set:nn { luatexcn / banxin } { chapter-title = { #1 } }
      }
  }

\ExplSyntaxOff%
%
\endinput%
