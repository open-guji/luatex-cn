% Copyright 2026 Open-Guji (https://github.com/open-guji)
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%     http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
% luatex-cn-core-textflow.sty
% TextFlow (双行小注/夹注) support for vertical typesetting
% This is a subpackage of luatex_cn
%
% NOTE: This file must be loaded AFTER vertical keys are defined
%
\RequirePackage{core/luatex-cn-core-base}
\RequirePackage{expl3}
\RequirePackage{xparse}
\ProvidesExplPackage {core/luatex-cn-core-textflow} {2026/02/01} {0.2.3} {TextFlow (Jiazhu) Support for Vertical Typesetting}

% TextFlow Command (双行小注/夹注)
% Syntax: \TextFlow{content}
\makeatletter

    \keys_define:nn { luatexcn / textflow }
      {
        only-column .choice:,
        only-column / left .code:n = { \tl_set:Nn \l_tmpa_tl {2} },
        only-column / right .code:n = { \tl_set:Nn \l_tmpa_tl {1} },
        only-column / none .code:n = { \tl_set:Nn \l_tmpa_tl {0} },
        only-column .initial:n = none,

        font-size .tl_set:N = \l__luatexcn_jiazhu_local_size_tl,
        font .tl_set:N = \l__luatexcn_jiazhu_local_font_tl,
        font-color .tl_set:N = \l__luatexcn_jiazhu_local_color_tl,
      }

    \NewDocumentCommand{\TextFlow}{ O{} +m }
      {
        \group_begin:

        % Initialize temp var for mode (0 = balanced/default)
        \tl_set:Nn \l_tmpa_tl {0}
        % Initialize local override variables
        \tl_set:Nn \l__luatexcn_jiazhu_local_size_tl {}
        \tl_set:Nn \l__luatexcn_jiazhu_local_font_tl {}
        \tl_set:Nn \l__luatexcn_jiazhu_local_color_tl {}

        \keys_set:nn { luatexcn / textflow } { #1 }

        % Capture attribute values using edef BEFORE selectfont
        % Note: indent values are now inherited from style stack (no longer saved/restored here)
        \edef\savedblockid{\the\cnverticalblockid}

        % 1. Determine Font Size (Local > Global > Default 0.7)
        \tl_if_empty:NTF \l__luatexcn_jiazhu_local_size_tl
          {
            \tl_set:Nx \l_tmpb_tl { \l__luatexcn_jiazhu_size_tl }
            \tl_if_empty:NTF \l_tmpb_tl
              { \tl_set:Nx \l_tmpc_tl { \fp_eval:n { 0.7 * \f@size } pt } }
              { \tl_set_eq:NN \l_tmpc_tl \l__luatexcn_jiazhu_size_tl }
          }
          { \tl_set_eq:NN \l_tmpc_tl \l__luatexcn_jiazhu_local_size_tl }

        % 2. Determine Font (Local > Global)
        \tl_if_empty:NTF \l__luatexcn_jiazhu_local_font_tl
          { \tl_set_eq:NN \l_tmpb_tl \l__luatexcn_jiazhu_font_tl }
          { \tl_set_eq:NN \l_tmpb_tl \l__luatexcn_jiazhu_local_font_tl }

        % 3. Determine Color (Local > Global)
        \tl_if_empty:NTF \l__luatexcn_jiazhu_local_color_tl
          { \tl_set_eq:NN \l_tmpd_tl \l__luatexcn_jiazhu_font_color_tl }
          { \tl_set_eq:NN \l_tmpd_tl \l__luatexcn_jiazhu_local_color_tl }

        % Apply Font and Size
        \tl_if_empty:NTF \l_tmpb_tl
          { \fontsize{\l_tmpc_tl}{\l_tmpc_tl}\selectfont }
          { \setmainfont{\l_tmpb_tl}[RawFeature={+vert,+vrt2}] \fontsize{\l_tmpc_tl}{\l_tmpc_tl}\selectfont }

        % Apply Color (visual appearance)
        \tl_if_empty:NF \l_tmpd_tl
          {
            % Simple heuristic: if it contains a comma or space, it's numeric RGB
            \tl_if_in:NnTF \l_tmpd_tl { , }
              { \color[rgb]{\l_tmpd_tl} }
              {
                \tl_if_in:NnTF \l_tmpd_tl { ~ }
                  {
                    \tl_set:Nx \l_tmpe_tl { \l_tmpd_tl }
                    \tl_replace_all:Nnn \l_tmpe_tl { ~ } { , }
                    \color[rgb]{\l_tmpe_tl}
                  }
                  { \color{\l_tmpd_tl} }
              }
          }

        % Push style to stack and get style ID (Phase 3: Style Stack Management)
        \edef\jiazhu_style_id{\lua_now:e {
          local ~ textflow = require('core.luatex-cn-textflow')
          local ~ style_id = textflow.jiazhu_push_style(
            \tl_if_empty:NTF \l_tmpd_tl { nil } { [=[\luaescapestring{\tl_use:N \l_tmpd_tl}]=] },
            [=[\luaescapestring{\tl_use:N \l_tmpc_tl}]=],
            \tl_if_empty:NTF \l_tmpb_tl { nil } { [=[\luaescapestring{\tl_use:N \l_tmpb_tl}]=] }
          )
          tex.print(tostring(style_id))
        }}

        % CRITICAL: Set jiazhu attribute AFTER selectfont
        \setluatexattribute\cnverticaljiazhu{1}
        \setluatexattribute\cnverticaljiazhumode{\l_tmpa_tl}
        \setluatexattribute\cnverticalstyle{\jiazhu_style_id}

        % Restore block ID only (indent inherited from style stack)
        \cnverticalblockid = \savedblockid\relax

        #2

        % Pop style from stack
        \lua_now:n {
          local ~ textflow = require('core.luatex-cn-textflow')
          textflow.jiazhu_pop_style()
        }

        \group_end:
      }

    \NewDocumentCommand{\DanHangJiaZhu}{ O{right} +m }
      {
        \TextFlow[only-column=#1]{#2}
      }

\makeatother

\ExplSyntaxOff%

% Command Alias for CJK
\NewCommandCopy{\文本流}{\TextFlow}

\endinput%
