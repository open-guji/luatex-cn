% Copyright 2026 Open-Guji (https://github.com/open-guji)
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%     http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
% luatex-cn-decorate.sty
% Character decoration support for vertical typesetting
% This is a subpackage of luatex_cn
%
\RequirePackage{expl3}
\RequirePackage{xparse}
\ProvidesExplPackage {decorate/luatex-cn-decorate} {2026/01/31} {0.2.2} {Character Decoration Support}

% Decorate Command - Zero-width decoration for the previous character
% Creates a whatsit node that will be processed by Lua to overlay on the previous character
% Syntax: \decorate[color=red, xoffset=0pt, yoffset=0pt, font-size=6pt]{content}

\tl_new:N \l__luatexcn_decorate_color_tl
\tl_new:N \l__luatexcn_decorate_xoffset_tl
\tl_new:N \l__luatexcn_decorate_yoffset_tl
\tl_new:N \l__luatexcn_decorate_font_size_tl
\tl_new:N \l__luatexcn_decorate_scale_tl

\keys_define:nn { luatexcn / decorate }
  {
    color .tl_set:N = \l__luatexcn_decorate_color_tl,
    color .initial:n = red,
    xoffset .tl_set:N = \l__luatexcn_decorate_xoffset_tl,
    xoffset .initial:n = 0pt,
    xshift .tl_set:N = \l__luatexcn_decorate_xoffset_tl,
    yoffset .tl_set:N = \l__luatexcn_decorate_yoffset_tl,
    yoffset .initial:n = 0pt,
    yshift .tl_set:N = \l__luatexcn_decorate_yoffset_tl,
    font-size .initial:n = ,
    scale .tl_set:N = \l__luatexcn_decorate_scale_tl,
    scale .initial:n = 1.0,
  }

\NewDocumentCommand{\decorate}{ O{} m }{%
  \group_begin:
    \keys_set:nn { luatexcn / decorate } { #1 }
    \lua_now:e {
      local~constants~=~require('core.luatex-cn-constants')
      constants.register_decorate(
        "\luaescapestring{#2}",
        "\luaescapestring{\l__luatexcn_decorate_xoffset_tl}",
        "\luaescapestring{\l__luatexcn_decorate_yoffset_tl}",
        "\luaescapestring{\l__luatexcn_decorate_font_size_tl}",
        "\luaescapestring{\l__luatexcn_decorate_color_tl}",
        font.current(),
        "\luaescapestring{\l__luatexcn_decorate_scale_tl}"
      )
    }
    \box0\scan_stop:
  \group_end:
}

% Alias for CJK name
\NewCommandCopy{\装饰}{\decorate}

% 改 (Fix/Correction) Command - Mark a character as corrected
% Used in classical Chinese text editing: 甲\改{乙} means "甲 is corrected to 乙"
% This overlays a 、(deletion mark) on the previous character and places the
% replacement character at bottom-right corner at half the font size
% Syntax: \改{replacement character}
\NewDocumentCommand{\改}{ m }{%
  \group_begin:
    % First: overlay a 、 symbol to mark deletion (centered on the character)
    \lua_now:e {
      local~constants~=~require('core.luatex-cn-constants')
      constants.register_decorate(
        "、",
        "0em",
        "0em",
        nil,
        "black",
        nil,
        2
      )
    }%
    \box0\scan_stop:
    % Second: add the replacement character at bottom-right, half size
    \lua_now:e {
      local~constants~=~require('core.luatex-cn-constants')
      constants.register_decorate(
        "\luaescapestring{#1}",
        "-0.6em",
        "0.5em",
        nil,
        "black",
        nil,
        0.6
      )
    }%
    \box0\scan_stop:
  \group_end:
}

% Alias with English name
\NewCommandCopy{\fix}{\改}

\ExplSyntaxOff%
%
\endinput%
